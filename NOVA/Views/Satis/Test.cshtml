<head>
    <title>Nova | Ziyaret Planlama</title>
    <!-- Favicon -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/x-icon" href="/assets/img/icons/brands/Nova_White.png" />
    <script src="~/Scripts/jquery-3.6.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Public+Sans:ital,wght@0,300;0,400;0,500;0,600;0,700;1,300;1,400;1,500;1,600;1,700&display=swap"
          rel="stylesheet" type="text/css" />
    <link href="\assets\boxicons-2.1.2\css\boxicons.css" rel="stylesheet" type="text/css" />
    <link href="\assets\boxicons-2.1.2\css\animations.css" rel="stylesheet" type="text/css" />
    <link href="\assets\boxicons-2.1.2\css\transformations.css" rel="stylesheet" type="text/css" />

    <!-- Core CSS -->
    <link rel="stylesheet" type="text/css" href="\assets\vendor\css\core.css" class="template-customizer-core-css" />
    <link rel="stylesheet" type="text/css" href="\assets\vendor\css\theme-default.css" class="template-customizer-theme-css" />
    <link rel="stylesheet" type="text/css" href="\assets\css\demo.css" />
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <!-- Vendors CSS -->
    <link rel="stylesheet" type="text/css" href="\assets\vendor\libs\perfect-scrollbar\perfect-scrollbar.css" />

    <link rel="stylesheet" type="text/css" href="\assets\vendor\libs/apex-charts/apex-charts.css" />

    <!-- Page CSS -->
    <!-- Helpers -->
    <script type="text/javascript" src="\assets\vendor\js\helpers.js"></script>

    <!--! Template customizer & Theme config files MUST be included after core stylesheets and helpers.js in the <head> section -->
    <!--? Config:  Mandatory theme config file contain global vars & default theme options, Set your preferred theme option in this file.  -->
    <script type="text/javascript" src="\assets\js\config.js"></script>
    <script src="/Scripts/jquery.validate.js" type='text/javascript'></script>
    <script src="/Scripts/jquery.validate.unobtrusive.js" type='text/javascript'></script>

    <script src="~/fullcalendar-scheduler-6.0.1/dist/index.global.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/i18n/tr.js"></script>
    <style>

        html, body {
            margin: 0;
            padding: 0;
            font-family: Calibri;
            font-size: 14px;
        }

        .accordion-button {
            margin: 0;
            background-color: #D0E0E3;
        }

            .accordion-button:not(.collapsed) {
                color: #566a7f;
                background-color: #D0E0E3;
                box-shadow: inset 0 0 0 #d9dee3;
            }

        .fc-license-message {
            display: none;
        }

        .fc-event .fc-event-main {
            position: relative;
            z-index: 2;
            padding: 2px 20px;
            background-color: #697FC2;
            border-radius: 0.375rem;
        }

        #external-events .fc-event {
            cursor: move;
            margin: 3px 0;
        }

        #external-events1 .fc-event {
            cursor: move;
            margin: 3px 0;
        }

        .fc-h-event {
            background-color: transparent;
            border: 1px solid transparent;
            display: block;
        }

        .fc-event-main {
            padding: 0 5px;
        }

        #calendar-container {
            position: fixed;
            z-index: 1;
            margin-left: 200px;
        }

        #calendar {
            max-width: 1100px;
            margin: 20px auto;
        }

        #external-events {
            position: relative;
            z-index: 2;
            top: 20px;
            left: 20px;
            width: 300px;
            padding: 0;
            margin: 0;
            border-radius: 12.5px;
        }

        #external-events1 {
            position: relative;
            z-index: 2;
            top: 20px;
            left: 20px;
            width: 300px;
            padding: 0;
            border-radius: 12.5px;
            margin-left: 3vw;
        }

        #menu2 {
            display: none;
        }

        .fc-theme-standard {
            border-color: red !important;
        }

        @@media screen and (max-width: 600px) {
            .fc-button-group {
                margin-bottom: 5px;
            }

            #menu1 {
                display: none;
            }

            #menu2 {
                display: unset;
            }
            #example1 caption {
                font-size: 1.3em;
            }

            #example1 thead {
                border: none;
                clip: rect(0 0 0 0);
                height: 1px;
                margin: -1px;
                overflow: hidden;
                padding: 0;
                position: absolute;
                width: 1px;
                display: none;
            }

            #example1 tr {
                border-bottom: 3px solid #ddd;
                display: block;
                margin-bottom: .625em;
            }

            #example1 td {
                border-bottom: 1px solid #ddd;
                display: block;
                font-size: .8em;
                text-align: right;
            }

            #example1 td::before {
                /*
    * aria-label has no advantage, it won't be read inside a table
    content: attr(aria-label);
    */
                content: attr(data-label);
                float: left;
                font-weight: bold;
                text-transform: uppercase;
            }

            #example1 td:last-child {
                border-bottom: 0;
            }
        }
    </style>
    <script>

        var calendar = null
        var drag = null;
        var gerceklesentarih = null;
        document.addEventListener('DOMContentLoaded', function () {
            var Calendar = FullCalendar.Calendar;
            var Draggable = FullCalendar.Draggable;

            var containerEl = document.getElementById('external-events');
            var calendarEl = document.getElementById('calendar');
            var checkbox = document.getElementById('drop-remove');

            // initialize the external events
            // -----------------------------------------------------------------

            drag=new Draggable(containerEl, {
                itemSelector: '.fc-event',
                eventData: function (eventEl) {
                    var j_selector = jQuery(eventEl);
                    return {
                        id: j_selector.data('id'),
                        title: eventEl.innerText
                    };
                }
            });

            // initialize the calendar
            // -----------------------------------------------------------------

            calendar = new Calendar(calendarEl, {
                headerToolbar: {
                    left: 'prev,next today',
                    center: 'title',
                    right: 'dayGridMonth,timeGridWeek,timeGridDay,listMonth'
                },
                locale: "tr",
                editable: true,
                droppable: true, // this allows things to be dropped onto the calendar
                eventTimeFormat: { // like '14:30:00'
                    hour: '2-digit',
                    minute: '2-digit',
                    meridiem: false
                },
                eventReceive: function (info) {



                    $.ajax({
                        type: 'POST',
                        url: '@Url.Action("RandevuEkleGuncelle", "Satis")',
                        data: JSON.stringify({ "INCKEY": "", "MUSTERI_ID": parseInt(info.event.id), "RANDEVU_NOTU": "", "PLANLANAN_TARIH": (info.event.start).toLocaleString("tr-TR") }),
                        contentType: "application/json",
                        success: function () {
                            const Toast = Swal.mixin({
                                toast: true,
                                position: 'center',
                                showConfirmButton: false,
                                timer: 3000,
                                timerProgressBar: true,
                                didOpen: (toast) => {
                                    toast.addEventListener('mouseenter', Swal.stopTimer)
                                    toast.addEventListener('mouseleave', Swal.resumeTimer)
                                }
                            })
                            refreshtable();
                            Toast.fire({
                                icon: 'success',
                                title: 'Ziyaret başarıyla kaydedildi!'
                            });
                            info.revert();
                        },
                        error: function () {

                        },
                        dataType: 'json'
                    })



                },
                eventDrop: function (date) {

                    var d = (date.event.start).toLocaleString("tr-TR");
                    var txt = "Ziyaret planını " + d.split(' ')[0] + " " + (d.split(' ')[1].split(':').slice(0, 2)).toString().replace(',', ':') + " olarak güncellemek istediğinize emin misiniz?";
                    Swal.fire({
                        title: 'Onay',
                        icon: 'question',
                        confirmButtonColor: '#3085d6',
                        denyButtonColor: '#d33',
                        text: txt,
                        showDenyButton: true,
                        confirmButtonText: 'Güncelle',
                        denyButtonText: `Güncelleme!`,
                    }).then((result) => {

                        if (result.isConfirmed) {
                            $.ajax({
                                type: 'POST',
                                url: '@Url.Action("RandevuEkleGuncelle", "Satis")',
                                data: JSON.stringify({ "INCKEY": parseInt(date.event.extendedProps.inckey), "MUSTERI_ID": parseInt(date.event.id), "RANDEVU_NOTU": "", "PLANLANAN_TARIH": (date.event.start).toLocaleString("tr-TR") }),
                                contentType: "application/json",
                                success: function () {
                                    const Toast = Swal.mixin({
                                        toast: true,
                                        position: 'center',
                                        showConfirmButton: false,
                                        timer: 3000,
                                        timerProgressBar: true,
                                        didOpen: (toast) => {
                                            toast.addEventListener('mouseenter', Swal.stopTimer)
                                            toast.addEventListener('mouseleave', Swal.resumeTimer)
                                        }
                                    })
                                    refreshtable();
                                    Toast.fire({
                                        icon: 'success',
                                        title: 'Ziyaret başarıyla değiştirildi!'
                                    });
                                },
                                error: function () {

                                },
                                dataType: 'json'
                            })
                        } else if (result.isDenied) {
                            date.revert();
                            Swal.fire('Değişiklik kaydedilmedi', '', 'info')
                        }
                    })

                },
                eventClick: function (info) {



                        getRandevuAsync().then(function (data) {

                            var d = JSON.parse(data).filter(x => x.INCKEY == info.event.extendedProps.inckey);
                            $('#datepickermodal').modal('show');
                            $('#planlanan').val(d[0].PLANLANAN_TARIH);
                            $('#inckey').val(d[0].INCKEY);
                            $('#musid').val(d[0].MUSTERI_ID);
                            $('#musadi').text(info.event.title);
                            if (d[0].RANDEVU_NOTU != null) {
                                $('#not').val(d[0].RANDEVU_NOTU);
                            } else {
                                $('#not').val(null);
                            }
                            if (d[0].GERCEKLESEN_TARIH != null) {
                                gerceklesentarih = d[0].GERCEKLESEN_TARIH;
                                $('#gercekkolon').show();
                                $('#gercekth').show();
                                $('#complatebutton').hide();
                                $('#planlanan').prop("readonly",true);
                                $('#gerceklesen').val(d[0].GERCEKLESEN_TARIH);
                            } else {
                                $('#gercekkolon').hide();
                                $('#gercekth').hide();
                                $('#complatebutton').show();
                                $('#planlanan').prop("readonly", false);
                            }
                        })




                        //info.event.remove();




                },
                eventResize: function (info) {
                    info.revert();
                },
                dateClick: function (info) {
                    calendar.changeView('timeGridDay', info.dateStr);
                },
                themeSystem: 'bootstrap5'
            })






        });

    </script>
    <script src="//cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    
</head>

<body>
    <div class="container-fluid">
        <div class="row">
            
                
            
            <div id="menu1" class="col-sm-1">
                
                <div id='external-events'>
                    
                    <select class="form-control" id="plasiyer" onchange="plasiyerchange(this.value)" name="PLASIYER">
                    </select>
                    <script>
                        $.ajax({
                            url: '@Url.Action("GetActiveUsers", "Satis")',
                            type: 'POST',
             success: function (result) {
                 var data = JSON.parse(result);
                  var username=@Html.Raw(Json.Encode(Request.Cookies["UserName"].Value));
                 for (let i = 0; i < data.length; i++) {
                     if (data[i].USER_NAME != "admin" && data[i].USER_NAME != "test") {
                         var option = document.createElement("option");
                         option.innerHTML = data[i].USER_NAME;
                         option.value = data[i].USER_NAME;
                         if (data[i].USER_NAME == username) {
                             option.selected = "true";
                         }
                         $("#plasiyer").append(option);
                     }
                     $("#plasiyer").select2();
                 }
                            }
                 })
                        function plasiyerchange(value) {
                            
                                
                            getMusterilerAsync().then(function (data) {
                                $("#musterison20").empty();
                                $("#musteri").empty();
                                var musteriler = JSON.parse(data).filter(x => x.PLASIYER == value).sort((a, b) => (a.MUSTERI_ADI > b.MUSTERI_ADI) ? 1 : -1);

                                var musteriler20 = JSON.parse(data).filter(x => x.PLASIYER == value).sort((a, b) => (a.KAYIT_TARIHI > b.KAYIT_TARIHI) ? -1 : 1);
                                var leng = musteriler20.length;
                                if (leng > 15) {
                                    leng = 15;
                                }
                                for (let i = 0; i < musteriler.length; i++) {
                                    var st = "<div class='fc-event fc-h-event fc-daygrid-event fc-daygrid-block-event m1' data-id=" + musteriler[i].MUSTERI_ID + "><div class='fc-event-main' style='background-color:#697FC2;border-style:hidden'>" + musteriler[i].MUSTERI_ADI + "</div></div>"
                                    mus.append(st);
                                    var st1 = "<div class='fc-event fc-h-event fc-daygrid-event fc-daygrid-block-event m2' data-id=" + musteriler[i].MUSTERI_ID + "><div class='fc-event-main'>" + musteriler[i].MUSTERI_ADI + "</div></div>"
                                    mus2.append(st1);
                                }
                                for (let i = 0; i < leng; i++) {
                                    var st = "<div class='fc-event fc-h-event fc-daygrid-event fc-daygrid-block-event' data-id=" + musteriler20[i].MUSTERI_ID + "><div class='fc-event-main'>" + musteriler20[i].MUSTERI_ADI + "</div></div>"
                                    mus3.append(st);
                                    mus4.append(st);
                                }
                                getRandevuAsync()
                                    .then(function (result) {
                                        var musteriler = JSON.parse(data).filter(x => x.PLASIYER == value);
                                        calendar.removeAllEvents();
                                        var d = JSON.parse(result);
                                        for (let i = 0; i < musteriler.length; i++) {
                                            var musid = d.filter(x => x.MUSTERI_ID == musteriler[i].MUSTERI_ID);
                                            if (musid.length > 0) {
                                                var musadi = musteriler.filter(x => x.MUSTERI_ID == musid[0].MUSTERI_ID);
                                                for (let a = 0; a < musid.length; a++) {
                                                    var color = "";
                                                    if (Date.parse(musid[a].PLANLANAN_TARIH) > Date.now()) {
                                                        color = "#3D85C6";
                                                    } else {
                                                        color = "#C1C1C1";
                                                    }
                                                    if (musid[a].GERCEKLESEN_TARIH != null) {
                                                        color = "#CC0000";
                                                    }
                                                    calendar.addEvent({
                                                        id: musid[a].MUSTERI_ID,
                                                        title: musadi[0].MUSTERI_ADI,
                                                        start: new Date(musid[a].PLANLANAN_TARIH),
                                                        inckey: musid[a].INCKEY,
                                                        backgroundColor: color
                                                    });
                                                }

                                            }



                                        }





                                    }).then(function () {
                                        $('#editbutton').show();
                                        $('#deletebutton').show();
                                        $('#guncellebutton').hide();
                                        $('#iptalbutton').hide();
                                        $('#not').prop("disabled", true);
                                        $('#planlanan').prop("disabled", true);
                                        $('#gerceklesen').prop("disabled", true);
                                        if (value != username) {
                                            calendar.setOption('droppable', false);
                                            calendar.setOption('editable', false);
                                            calendar.setOption('eventClick', null);
                                        } else {
                                            calendar.setOption('droppable', true);
                                            calendar.setOption('editable', true);
                                            calendar.setOption('eventClick', function (info) {



                                                getRandevuAsync().then(function (data) {

                                                    var d = JSON.parse(data).filter(x => x.INCKEY == info.event.extendedProps.inckey);
                                                    $('#datepickermodal').modal('show');
                                                    $('#planlanan').val(d[0].PLANLANAN_TARIH);
                                                    $('#inckey').val(d[0].INCKEY);
                                                    $('#musid').val(d[0].MUSTERI_ID);
                                                    $('#musadi').text(info.event.title);
                                                    if (d[0].RANDEVU_NOTU != null) {
                                                        $('#not').val(d[0].RANDEVU_NOTU);
                                                    } else {
                                                        $('#not').val(null);
                                                    }
                                                    if (d[0].GERCEKLESEN_TARIH != null) {
                                                        gerceklesentarih = d[0].GERCEKLESEN_TARIH;
                                                        $('#gercekkolon').show();
                                                        $('#gercekth').show();
                                                        $('#complatebutton').hide();
                                                        $('#planlanan').prop("readonly", true);
                                                        $('#gerceklesen').val(d[0].GERCEKLESEN_TARIH);
                                                        $('#gerceklesen').prop("readonly", true);
                                                    } else {
                                                        $('#gercekkolon').hide();
                                                        $('#gercekth').hide();
                                                        $('#complatebutton').show();
                                                        $('#planlanan').prop("readonly", false);
                                                        $('#gerceklesen').prop("readonly", false);
                                                    }
                                                })




                                                //info.event.remove();




                                            });
                                        }
                                        
                                    })
                            })
                        }
                    </script>
                    <div class="accordion mt-2">
                        <div class="accordion-item" style="background-color:transparent">
                            <h2 class="accordion-header" id="headingOne">
                                <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#flush-collapseOne" aria-expanded="true" aria-controls="flush-collapseOne">
                                    En Son Eklenen Müşteriler
                                </button>
                            </h2>
                            <div id="flush-collapseOne" class="accordion-collapse collapse show" aria-labelledby="headingOne" data-bs-parent="#external-events">
                                <div id="musterison20" style="max-height:700px;overflow-y:auto">

                                </div>
                            </div>
                        </div>
                        <div class="accordion-item mt-2 mb-2" style="background-color:transparent">
                            <h2 class="accordion-header " id="headingtwo">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#flush-collapseTwo" aria-expanded="false" aria-controls="flush-collapseTwo">
                                    Tüm Müşteriler
                                </button>
                            </h2>
                            <div id="flush-collapseTwo" class="accordion-collapse collapse" aria-labelledby="headingtwo" data-bs-parent="#external-events">
                                <div id="musteri" style="max-height:700px;overflow-y:auto">
                                    <input class="form-control position-sticky stivky-top mt-1" type="text" id="Search" onkeyup="myFunction()" placeholder="Müşteri Ara..">
                                </div>
                            </div>
                        </div>
                    </div>
                    <script>
                        function myFunction() {
                            var input = document.getElementById("Search");
                            var filter = input.value.toLowerCase().replace('ı', 'i');
                            var nodes = document.getElementsByClassName('m1');

                            for (i = 0; i < nodes.length; i++) {
                                if (nodes[i].innerText.toLowerCase().includes(filter)) {
                                    nodes[i].style.display = "block";
                                } else {
                                    nodes[i].style.display = "none";
                                }
                            }
                        }
                    </script>


                </div>
            </div>
            <div class="col-sm">


                <div id='calendar'></div>

            </div>
        </div>
        <div id="menu2" class="row">
            <div class="col-sm-1">
                <div id='external-events1'>

                    <div class="accordion mt-2">
                        <div class="accordion-item" style="background-color:transparent">
                            <h2 class="accordion-header" id="headingOne1">
                                <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#flush-collapseOne1" aria-expanded="true" aria-controls="flush-collapseOne1">
                                    En Son Eklenen Müşteriler
                                </button>
                            </h2>
                            <div id="flush-collapseOne1" class="accordion-collapse show" aria-labelledby="headingOne1" data-bs-parent="#external-events1">
                                <div id="musterison200" style="max-height:700px;overflow-y:auto">

                                </div>
                            </div>
                        </div>
                        <div class="accordion-item mt-2 mb-2" style="background-color:transparent">
                            <h2 class="accordion-header " id="headingtwo1">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#flush-collapseTwo1" aria-expanded="false" aria-controls="flush-collapseTwo1">
                                    Tüm Müşteriler
                                </button>
                            </h2>
                            <div id="flush-collapseTwo1" class="accordion-collapse collapse" aria-labelledby="headingtwo1" data-bs-parent="#external-events1">
                                <div id="musteri2" style="max-height:700px;overflow-y:auto">
                                    <input class="form-control position-sticky sticky-top" type="text" id="Search1" onkeyup="myFunction1()" placeholder="Müşteri Ara..">
                                </div>
                            </div>
                        </div>
                    </div>

                    <script>
                        function myFunction1() {
                            var input = document.getElementById("Search1");
                            var filter = input.value.toLowerCase().replace('ı', 'i');
                            var nodes = document.getElementsByClassName('m2');

                            for (i = 0; i < nodes.length; i++) {
                                if (nodes[i].innerText.toLowerCase().includes(filter)) {
                                    nodes[i].style.display = "block";
                                } else {
                                    nodes[i].style.display = "none";
                                }
                            }
                        }
                    </script>

                </div>
            </div>
        </div>

        <div class="modal fade" id="datepickermodal" tabindex="-1" aria-hidden="true" style="display: none;">

            <div class="modal-dialog modal-dialog-centered modal-xl" role="document">
                <div class="modal-content">
                    <div class="modal-header">




                        <button type="button" class="btn-close" data-bs-dismiss="modal" id="close" aria-label="Close"></button>

                    </div>
                    <div id="planlarim" class="modal-body" style="display:block">
                        <div class="row">



                            <div class="col-sm">


                                <div class="table-responsive">
                                    <table class="table table-striped table-bordered" id="example1">
                                        <thead class="thead-dark" id="thead">
                                            <tr>
                                                <th scope="col">Müşteri Adı</th>
                                                <th scope="col">Planlanan Tarih</th>
                                                <th scope="col" id="gercekth">Gerçekleşen Tarih</th>
                                                <th scope="col">Ziyaret Notu</th>
                                                <th scope="col">Onay</th>

                                            </tr>
                                        </thead>
                                        <tbody id="bdy1">
                                            <tr>
                                                <td scope="col" class="text-center"><label class="form-label fw-bold" id="musadi" /></td>
                                                <td scope="col"><input class="form-control" type="datetime-local" id="planlanan" /></td>
                                                <td scope="col" id="gercekkolon"><input class="form-control" type="datetime-local" id="gerceklesen" /></td>
                                                <td scope="col"><textarea class="form-control" id="not" rows="4" cols="4"></textarea></td>
                                                <td scope="col" class="d-none"><input class="form-control" type="text" id="inckey" /></td>
                                                <td scope="col" class="d-none"><input class="form-control" type="text" id="musid" /></td>
                                                <td scope="col" class="text-center"><a onclick="guncelle1()" style="cursor: pointer;" id="editbutton"><i class="bx bx-edit bx-md bx-tada-hover"></i></a><a onclick="sil()" style="cursor: pointer;" id="deletebutton"><i class="bx bx-trash bx-md bx-tada-hover"></i></a><a onclick="gerceklesen()" style="cursor: pointer;" id="complatebutton"><i class="bx bx-like bx-md bx-tada-hover"></i></a><a onclick="guncelle()" style="cursor: pointer;" id="guncellebutton"><i class='bx bx-md bxs-check-circle bx-md bx-tada-hover'></i></a><a onclick="iptal()" style="cursor: pointer;" id="iptalbutton"><i class='bx bxs-x-circle bx-md bx-tada-hover'></i></a></td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                               


                            </div>
                        </div>

                    </div>


                </div>

            </div>





        </div>
    </div>
    
        
    <script>
        function gerceklesen() {
            $.ajax({
                                                type: 'POST',
                url: '@Url.Action("RandevuGerceklesen", "Satis")',
                data: JSON.stringify({ "id": parseInt(document.getElementById("inckey").value) }),
                                                contentType: "application/json",
                success: function () {
                    $('#datepickermodal').modal('hide');
                                                    const Toast = Swal.mixin({
                                                        toast: true,
                                                        position: 'center',
                                                        showConfirmButton: false,
                                                        timer: 3000,
                                                        timerProgressBar: true,
                                                        didOpen: (toast) => {
                                                            toast.addEventListener('mouseenter', Swal.stopTimer)
                                                            toast.addEventListener('mouseleave', Swal.resumeTimer)
                                                        }
                                                    })
                                                    refreshtable();
                                                    Toast.fire({
                                                        icon: 'success',
                                                        title: 'Ziyaret başarıyla güncellendi!'
                                                    });

                                                },
                                                error: function () {

                                                },
                                                dataType: 'json'
                                            });
        }
        function sil() {

             $.ajax({
                        type: 'POST',
                 url: '@Url.Action("RandevuSil", "Satis")',
                 data: JSON.stringify({ "INCKEY": document.getElementById("inckey").value }),
                                contentType: "application/json",
                 success: function () {
                     $('#datepickermodal').modal('hide');
                                    const Toast = Swal.mixin({
                                        toast: true,
                                        position: 'center',
                                        showConfirmButton: false,
                                        timer: 3000,
                                        timerProgressBar: true,
                                        didOpen: (toast) => {
                                            toast.addEventListener('mouseenter', Swal.stopTimer)
                                            toast.addEventListener('mouseleave', Swal.resumeTimer)
                                        }
                                    })
                                    refreshtable();
                                    Toast.fire({
                                        icon: 'success',
                                        title: 'Ziyaret başarıyla silindi!'
                                    });

                                },
                                error: function () {

                                },
                                dataType: 'json'
                            });
            }
        function guncelle1() {
                $('#guncellebutton').show();
                $('#iptalbutton').show();
                $('#deletebutton').hide();
                $('#editbutton').hide();
                $('#complatebutton').hide();
                $('#not').prop("disabled", false);
                $('#planlanan').prop("disabled", false);
                $('#gerceklesen').prop("disabled", false);
            }
        function iptal() {
                $('#guncellebutton').hide();
                $('#iptalbutton').hide();
                $('#deletebutton').show();
                $('#editbutton').show();
                $('#complatebutton').show();
                $('#not').prop("disabled", true);
                $('#planlanan').prop("disabled", true);
                $('#gerceklesen').prop("disabled", true);
            }
        function guncelle() {
            var data = null;

            if (document.getElementById("gerceklesen").value != "") {

                if (document.getElementById("gerceklesen").value != gerceklesentarih.slice(0, 16)) {
                    data = { "INCKEY": document.getElementById("inckey").value, "MUSTERI_ID": document.getElementById("musid").value, "RANDEVU_NOTU": document.getElementById("not").value, "PLANLANAN_TARIH": document.getElementById("planlanan").value, "GERCEKLESEN_TARIH": document.getElementById("gerceklesen").value };
                }

            } else {
                data = { "INCKEY": document.getElementById("inckey").value, "MUSTERI_ID": document.getElementById("musid").value, "RANDEVU_NOTU": document.getElementById("not").value, "PLANLANAN_TARIH": document.getElementById("planlanan").value};
            }

             $.ajax({
                        type: 'POST',
                 url: '@Url.Action("RandevuEkleGuncelle", "Satis")',
                 data: JSON.stringify(data),
                                contentType: "application/json",
                 success: function () {

                                    const Toast = Swal.mixin({
                                        toast: true,
                                        position: 'center',
                                        showConfirmButton: false,
                                        timer: 3000,
                                        timerProgressBar: true,
                                        didOpen: (toast) => {
                                            toast.addEventListener('mouseenter', Swal.stopTimer)
                                            toast.addEventListener('mouseleave', Swal.resumeTimer)
                                        }
                                    })
                     $('#datepickermodal').modal('hide');
                     refreshtable();
                                    Toast.fire({
                                        icon: 'success',
                                        title: 'Ziyaret başarıyla güncellendi!'
                                    });


                                },
                                error: function () {

                                },
                                dataType: 'json'
                            });
        }
         async function getMusterilerAsync() {
                let response = await fetch(`@Url.Action("GetMusteriler","Satis")`);
                let data = await response.json()
                return data;
        }
        async function getRandevuAsync() {
                let response = await fetch(`@Url.Action("GetRandevu","Satis")`);
                let data = await response.json()
                return data;
        }
        Date.prototype.addHours = function (h) {
            this.setTime(this.getTime() + (h * 60 * 60 * 1000));
            return this;
        }
        function refreshtable() {
            var username=@Html.Raw(Json.Encode(Request.Cookies["UserName"].Value));
            getMusterilerAsync().then(function (data) {
                getRandevuAsync()
                    .then(function (result) {
                        var musteriler = JSON.parse(data).filter(x=>x.PLASIYER==username);
                        calendar.removeAllEvents();
                        var d = JSON.parse(result);
                        for (let i = 0; i < musteriler.length; i++) {
                            var musid = d.filter(x => x.MUSTERI_ID == musteriler[i].MUSTERI_ID);
                            if (musid.length > 0) {
                                var musadi = musteriler.filter(x => x.MUSTERI_ID == musid[0].MUSTERI_ID);
                                for (let a = 0; a < musid.length; a++) {
                                    var color = "";
                                    if (Date.parse(musid[a].PLANLANAN_TARIH) > Date.now()) {
                                        color = "#3D85C6";
                                    } else {
                                        color = "#C1C1C1";
                                    }
                                    if (musid[a].GERCEKLESEN_TARIH != null) {
                                        color = "#CC0000";
                                    }
                                    calendar.addEvent({
                                        id: musid[a].MUSTERI_ID,
                                        title: musadi[0].MUSTERI_ADI,
                                        start: new Date(musid[a].PLANLANAN_TARIH),
                                        inckey: musid[a].INCKEY,
                                        backgroundColor: color
                                    });
                                }

                            }



                        }





                    }).then(function () {
                        $('#editbutton').show();
                        $('#deletebutton').show();
                        $('#guncellebutton').hide();
                        $('#iptalbutton').hide();
                        $('#not').prop("disabled", true);
                        $('#planlanan').prop("disabled", true);
                        $('#gerceklesen').prop("disabled", true);
                        calendar.render();
                    })
            })



        }
        var username= null;
        var id = null;
            var mus = $('#musteri');
            var mus2 = $('#musteri2');
            var mus3 = $('#musterison20');
            var mus4 = $('#musterison200');
            var musteriler = null;
            var musteriler20 = null;
        $(document).ready(function () {
            var ozelyetki = @Html.Raw(Json.Encode(ViewBag.OzelYetki));
            if (ozelyetki != 1) {
                $('#plasiyer').next(".select2-container").hide();
            }
            username = @Html.Raw(Json.Encode(Request.Cookies["UserName"].Value));
            id = @Html.Raw(Json.Encode(Request.Cookies["Id"].Value));

            $('#guncellebutton').hide();
            $('#iptalbutton').hide();
            $('#not').prop("disabled", true);
            $('#planlanan').prop("disabled", true);
            $('#gerceklesen').prop("disabled", true);
            getMusterilerAsync()
                .then(function (result) {

                    musteriler = JSON.parse(result).filter(x => x.PLASIYER == username).sort((a, b) => (a.MUSTERI_ADI > b.MUSTERI_ADI) ? 1 : -1);

                    musteriler20 = JSON.parse(result).filter(x => x.PLASIYER == username).sort((a, b) => (a.KAYIT_TARIHI > b.KAYIT_TARIHI) ? -1 : 1);
                    var leng = musteriler20.length;
                    if (leng > 15) {
                        leng = 15;
                    }
                    for (let i = 0; i < musteriler.length; i++) {
                        var st = "<div class='fc-event fc-h-event fc-daygrid-event fc-daygrid-block-event m1' data-id=" + musteriler[i].MUSTERI_ID + "><div class='fc-event-main' style='background-color:#697FC2;border-style:hidden'>" + musteriler[i].MUSTERI_ADI+"</div></div>"
                        mus.append(st);
                        var st1 = "<div class='fc-event fc-h-event fc-daygrid-event fc-daygrid-block-event m2' data-id=" + musteriler[i].MUSTERI_ID + "><div class='fc-event-main'>" + musteriler[i].MUSTERI_ADI + "</div></div>"
                        mus2.append(st1);
                    }
                    for (let i = 0; i < leng; i++) {
                        var st = "<div class='fc-event fc-h-event fc-daygrid-event fc-daygrid-block-event' data-id=" + musteriler20[i].MUSTERI_ID + "><div class='fc-event-main'>" + musteriler20[i].MUSTERI_ADI + "</div></div>"
                        mus3.append(st);
                        mus4.append(st);
                    }

                }).then(function () {
                    getRandevuAsync()
                        .then(function (result) {
                            var d = JSON.parse(result);
                            for (let i = 0; i < musteriler.length; i++) {
                                var musid = d.filter(x => x.MUSTERI_ID == musteriler[i].MUSTERI_ID);
                                if (musid.length > 0) {
                                    var musadi = musteriler.filter(x => x.MUSTERI_ID == musid[0].MUSTERI_ID);
                                    for (let a = 0; a < musid.length; a++) {
                                        var color = "";
                                        if (Date.parse(musid[a].PLANLANAN_TARIH) > new Date()) {

                                            color = "#3D85C6";
                                        } else {

                                            color = "#C1C1C1";
                                        }
                                        if (musid[a].GERCEKLESEN_TARIH != null) {

                                            color = "#CC0000";
                                        }
                                        calendar.addEvent({
                                            id: musid[a].MUSTERI_ID,
                                            title: musadi[0].MUSTERI_ADI,
                                            start: new Date(musid[a].PLANLANAN_TARIH),
                                            inckey: musid[a].INCKEY,
                                            backgroundColor: color
                                        });
                                    }

                                }



                            }
                            calendar.render();
                            document.getElementsByClassName("fc-listMonth-button")[0].innerHTML = "Liste";
                            document.getElementsByClassName("fc-listMonth-button")[0].onclick = function () {
                                document.getElementsByClassName("fc-listMonth-button")[0].innerHTML = "Liste";
                            }
                            document.getElementsByClassName("fc-dayGridMonth-button")[0].onclick = function () {
                                document.getElementsByClassName("fc-listMonth-button")[0].innerHTML = "Liste";
                            }
                            document.getElementsByClassName("fc-timeGridWeek-button")[0].onclick = function () {
                                document.getElementsByClassName("fc-listMonth-button")[0].innerHTML = "Liste";
                            }
                            document.getElementsByClassName("fc-timeGridDay-button")[0].onclick = function () {
                                document.getElementsByClassName("fc-listMonth-button")[0].innerHTML = "Liste";
                            }
                        })

                })

        })
    </script>

</body>



