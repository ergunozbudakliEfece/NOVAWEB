
@{
    Layout = "/Views/Shared/_Layout_common.cshtml";
}



<!DOCTYPE html>



<html>
<head>
    <link rel="stylesheet" type="text/css" href="../dist/pivot.css">
    <script type="text/javascript" src="../dist/pivot.js"></script>
    <script src="~/lib/pivot/multifact-pivottable.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <style>
        .layout-container {
            min-height: 95vh;
        }

        body {
            font-size: 12px;
        }
        .pvtTotalLabel{
            display:none
        }
        .pvtTotal {
            display:none
        }
        .pvtGrandTotal{
            display:none
        }
        .foot{
            display:none;
        }
        .pvtTable thead tr:nth-child(1){
            position:sticky;
            top:-2px;
        }
    </style>
</head>
<body>
    <div class="container-fluid">


        <!-- #region Makineler -->

        <div class="row text-center">
            <div class="col">
                <div class="btn-group" role="group" aria-label="Basic radio toggle button group" id="makineler">

                    <input type="radio" class="btn-check" name="btnradio" id="btnradio02" autocomplete="off" onclick="c(this)" value="BK"><label class="btn btn-outline-primary" for="btnradio02">BK</label>
                    <input type="radio" class="btn-check" name="btnradio" id="btnradio12" autocomplete="off" onclick="c(this)" value="DL"><label class="btn btn-outline-primary" for="btnradio12">DL</label>
                    <input type="radio" class="btn-check" name="btnradio" id="btnradio32" autocomplete="off" onclick="c(this)" value="PB"><label class="btn btn-outline-primary" for="btnradio32">PB</label>
                    <input type="radio" class="btn-check" name="btnradio" id="btnradio52" autocomplete="off" onclick="c(this)" value="RF"><label class="btn btn-outline-primary" for="btnradio52">RF</label>
                    <input type="radio" class="btn-check" name="btnradio" id="btnradio112" autocomplete="off" onclick="c(this)" value="TP"><label class="btn btn-outline-primary" for="btnradio112">TP</label>
                </div>
            </div>
        </div>

        <!-- #endregion -->
        <!-- #region DLHammadde -->

        <div class="row">
            <div class="col">
                <div class="card mt-2">



                    <div class="card-body me-3">
                        <div class="table-responsive text-nowrap">
                            <table class="table table-bordered" style="border-color:black;" id="table1">



                                <tbody>
                                    <tr style="background-image: linear-gradient(to right, #E0EAFC 0%, #CFDEF3 51%, #E0EAFC 100%)">
                                        <th class="text-center" style="font-size:12px">FABRİKA</th>
                                        <th class="text-center" style="font-size: 12px">ORAN</th>
                                        <th class="text-center" style="font-size: 12px">ÜRÜN KODU</th>
                                        <th class="text-center" style="font-size: 12px">STOK ADI</th>
                                        <th class="text-center" style="font-size: 12px">KONUM</th>
                                        <th class="text-center" style="font-size: 12px">MARKA</th>
                                        <th class="text-center" style="font-size: 12px">ADET</th>
                                        <th class="text-center" style="font-size: 12px">KALINLIK</th>
                                        <th class="text-center" style="font-size: 12px">GENİŞLİK | ±</th>
                                        <th class="text-center" style="font-size: 12px">KAPLAMA</th>
                                        <th class="text-center" style="font-size: 12px">KALİTE</th>
                                        <th class="text-wrap" style="font-size: 11px">KULL. METRAJ/TAM METRAJ</th>
                                        <th class="text-wrap" style="font-size: 11px">KULL. AĞIRLIK/TAM AĞIRLIK</th>



                                    </tr>
                                    <tr>
                                        <td id="fabrika" class="text-center">
                                            <span>MANİSA</span>
                                        </td>
                                        <td class="text-center p-0" id="or">
                                            <input class="border-0 text-center" style="width:80px" id="hamoran" type="number" value="1.0000">
                                            <script>
                                                var ham = document.getElementById("hamoran");
                                                ham.oninput = function () {
                                                    if (this.value >= 1) {
                                                        this.value = "1.0000";
                                                    } else if (this.value < 0) {
                                                        this.value = 0;
                                                    }
                                                };
                                            </script>
                                        </td>

                                        <td class="text-center p-0" id="urunkodu">
                                            <form>
                                                <input class="border-0 text-center" style="flex-grow:2;" id="seri" oninput="rechange()">
                                                <button type="button" id="rehberbutton" onclick="rehberAc()" class="btn btn-primary showmodal"><i class="bi bi-list-ul"></i></button>
                                                <i id="rehbermobil" style="cursor:pointer;display:none" onclick="rehberAc()" class="bi bi-list-ul"></i>
                                            </form>

                                        </td>
                                        <td class="text-center p-0">
                                            <textarea class="border-0 w-100 text-center text-wrap" id="stokadi" readonly=""></textarea>
                                        </td>
                                        <td class="text-center p-0">
                                            <input class="border-0  w-100 text-center" readonly="">
                                        </td>
                                        <td class="text-center p-0">
                                            <label class="border-0 text-center text-wrap" id="marka"></label>

                                        </td>
                                        <td class="text-center p-0">
                                            <input class="border-0 w-100 text-center" id="adet" readonly="">
                                        </td>
                                        <td class="text-center p-0">
                                            <input class="border-0 w-100 text-center" id="kalinlik" readonly="">
                                        </td>
                                        <td class="text-center p-0">
                                            <input class="border-0 w-px-50 text-center" id="genislik" readonly="">
                                            <input class="border-1 w-px-30 text-center" style="border-radius:5px" id="genislikalti" value="0" oninput="rechange()">
                                        </td>
                                        <td class="text-center p-0">
                                            <input class="border-0 w-100 text-center" id="kaplama" readonly="">
                                        </td>
                                        <td class="text-center p-0">
                                            <input class="border-0 w-100 text-center" id="kalite" readonly="">
                                        </td>
                                        <td class="text-center  p-0">
                                            <input class="border-0 w-100 text-center" id="metraj" readonly="">
                                        </td>

                                        <td class="text-center">
                                            <input class="border-0 w-100 text-center" id="agirlik" readonly="">
                                        </td>


                                    </tr>
                                    <tr style="display:none">
                                        <th style="background-image: linear-gradient(to right, #E0EAFC 0%, #CFDEF3 51%, #E0EAFC 100%); position: unset">
                                            MAKİNE
                                        </th>
                                        <th style="background-image: linear-gradient(to right, #E0EAFC 0%, #CFDEF3 51%, #E0EAFC 100%)">OPERATÖR</th>
                                        <td class="text-center">
                                            <input class="border-0 w-px-50">
                                        </td>
                                        <td class="text-center"><input class="border-0 w-px-50"></td>
                                        <td class="text-center">
                                            <input class="border-0 w-px-50">
                                        </td>
                                        <td class="text-center">
                                            <input class="border-0 w-px-50">
                                        </td>
                                        <td class="text-center"><input class="border-0 w-px-50"></td>
                                        <td class="text-center">
                                            <input class="border-0 w-px-50">
                                        </td>
                                        <td class="text-center">
                                            <input class="border-0 w-px-50">
                                        </td>
                                        <td class="text-center"><input class="border-0 w-px-50"></td>
                                        <td class="text-center">
                                            <input class="border-0 w-px-50">
                                        </td>
                                        <td class="text-center">
                                            <input class="border-0 w-px-50">
                                        </td>
                                        <th class="text-center ms-1" style="background-image: linear-gradient(to right, #E0EAFC 0%, #CFDEF3 51%, #E0EAFC 100%)">ÇIKIŞ</th>
                                        <td class="text-center">
                                            <input class="border-0 w-px-50">
                                        </td>

                                    </tr>

                                </tbody>
                            </table>
                        </div>


                    </div>
                </div>
            </div>
        </div>

        <!-- #endregion -->
        <!-- #region DLTable -->
       
        <div class="row mt-2">
            <div class="col">
                <div class="card">
                    <div class="card-body">
                        <div class="table-responsive">

                            <table class="table table-bordered border-dark" id="DLTable">



                                <tbody>
                                    <tr id="th" style="background-image: linear-gradient(to right, #E0EAFC 0%, #CFDEF3 51%, #E0EAFC 100%);">
                                        <th class=""></th>
                                        <th class="text-center" style="font-size: 11px;">ORAN</th>
                                        <th class="text-center" style="font-size: 11px;">MAKİNE</th>
                                        <th class="text-center" style="font-size: 11px;">STOK ÖLÇÜLERİ</th>
                                        <th class="text-center" style="font-size: 11px;">GENİŞLİK(Dilme)</th>
                                        <th class="text-center" style="font-size: 11px;">ADET(Dilme)</th>
                                        <th style="background-color:white;border-bottom:hidden;border-top:hidden;width:1px"></th>
                                        <th class="text-center" style="font-size: 11px">MAKİNE 1</th>
                                        <th class="text-center" style="font-size: 11px">STOK ÖLÇÜLERİ</th>
                                        <th class="text-center" style="font-size: 11px">ADET</th>
                                        <th style="background-color:white;border-bottom:hidden;border-top:hidden;width:1px"></th>
                                        <th class="text-center" style="font-size: 11px">AĞIRLIK</th>
                                        <th class="text-center" style="font-size: 11px">MÜŞTERİ</th>
                                    </tr>
                                    <tr>
                                        <td class="text-center p-1">1</td>
                                        <td class="p-1 text-center">
                                            <div>
                                                <input class="border-0 text-center ms-3" style="font-size:small;max-width:50px" type="number" value="1.00" max="1.00" min="0.00" onblur="oran(this)" />
                                                <div>
                                                    <img onclick="addRow1(this)" style="width:18px" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACQAAAAkCAYAAADhAJiYAAAAAXNSR0IArs4c6QAAAmlJREFUWEftmOFxFDEMhd9VQKiApAJIBUkHQAVABZAKQiogVABUAHRAKiCpINABVEDmu7FuhM5ey3s3zE4G/dm5W9l6lp7l511pYbZaGB7dG0BPJL2QxPOgPEn2taRf5fmpPIeKMJqht5JeFxCZQIC7lHSRccYnC+iZpHeSDrMTB78fks4kfemNzwAiK+dhop9l8m+SCEapMEoI6FNJLOJRGMdck9nqAfpYuGLzAoRJ+T9jL4u/B8bYV63BU4BiZr5KIgC8GDFID4inbhBZYv4tawEi3Z+dNzsGMLtYzPbzGqdagOCFpZnMALBl8OWkvLySBK9aBqktU8Q4io41QL5UcAaiTpXJ+zdLUQJTPoA8KL+3/GuACG4DIF+PwCOAwEHpPxRAxHrosxQBkY3vxYHsZPrOKCCm95Q49h09AqKr0omx95LeJFg8B1AzTgQEIY2g1V1QATgHkN/FbAQ2xtoiIDru4/Lur1SWQQbW42Iym5AF1XZZ3H2eGsQkVhXQHxcpgq0dIYmKrl1qu68aKwZdHKBeyTa1dqnJNMZYSl+yG6entji0OFIvbtv7VFbPmj1t+3RjJN6/PDp+RzncO1xZCT1in4frrQOROlzjWYNkoGu3LNMYbayXH9WzMivQJmVnsjvuJNCIETszq0OOzJGwyA0v8oYlrC06rgpOARRJmzG0D9cnhJnZpBzu3TpqmTKOkTEaKVzw1yCkr12Dop7qKcqhiyJNM96zMlnCB9Boq71cFH1QysXEJnF7gOgzLKR65akNzpSsNo6ODj/sY4NpKA5K+9gA/6yUPeCb93MBpQOMOv4H1MvYHYPjoiWLe0qnAAAAAElFTkSuQmCC">
                                                </div>
                                            </div>



                                        </td>
                                        <td class="border-0 text-center p-1 w-auto">

                                            <select class="js-select" style="width:150px" onchange="MachineChange(this)">

                                                <option selected disabled>MAKİNE SEÇİN</option>


                                                <option value="DL01">DL01</option>


                                            </select>






                                            <input class="border-0 text-center" id="1input" readonly style="display:none" />



                                        </td>

                                        <td class="p-1 text-center">
                                            <select class="js-select" style="width:200px" disabled>
                                                <option selected disabled>STOK SEÇİN</option>
                                                @foreach (var item in ViewBag.Stok_Adlari)
                                                {
                                                    <option value="@item.STOK_ADI">@item.STOK_ADI</option>
                                                }
                                            </select>


                                        </td>
                                        <td class="text-center p-1"><input class="border-0 text-center" style="width:120px" oninput="DlInputChange(this)" /></td>
                                        <td class="text-center p-1"><input class="border-0 text-center" style="width:120px" oninput="DlInputChange(this)" /></td>
                                        <td style="background-color:white;border-bottom:hidden;border-top:hidden;width:1px"></td>
                                        <td class="text-center p-1">
                                            <select class="js-select selectmakina2" style="width:150px" onchange="RefMachineChange(this)">

                                                <option selected disabled>MAKİNE SEÇİN</option>




                                            </select>
                                        </td>
                                        <td class="text-center p-1">
                                            <select class="js-select" style="width:200px" disabled onchange="RefStokChange(this)">
                                                <option selected disabled>STOK SEÇİN</option>
                                                @foreach (var item in ViewBag.Stok_Adlari)
                                                {
                                                    <option value="@item.STOK_ADI">@item.STOK_ADI</option>
                                                }
                                            </select>
                                        </td>
                                        <td class="text-center p-1">
                                        </td>
                                        <td style="background-color:white;border-bottom:hidden;border-top:hidden;width:1px"></td>
                                        <td class="text-center p-1">
                                            <input class="border-0 text-center" style="width:120px;display:none" readonly />
                                            <input class="border-0 text-center" style="width:120px" readonly="">
                                        </td>
                                        <td class="text-center p-1">
                                            <select class="js-select" style="width:150px">
                                                <option value="EFECE GALVANİZ" disabled selected>EFECE GALVANİZ</option>
                                            </select>
                                        </td>

                                    </tr>

                                </tbody>

                            </table>
                        </div>

                        <div class="row mt-3">
                            <div class="col">
                                <div class="table-responsive text-nowrap">
                                    <table class="table table-bordered" style="border-color:black;">
                                        <tbody>

                                            <tr style="background-image: linear-gradient(to right, #E0EAFC 0%, #CFDEF3 51%, #E0EAFC 100%);">
                                                <th class="text-center p-1" style="font-size: 11px; font-weight: bold; width: 20px">

                                                </th>
                                                <td class="text-center p-1" style="font-size: 11px;font-weight:bold;width:20px">
                                                    FİRE YÜZDESİ
                                                </td>
                                                <td class="text-center p-1" style="font-size: 11px; font-weight: bold; width: 20px">
                                                    FİRE GENİŞLİĞİ (mm)
                                                </td>
                                                <td class="text-center p-1" style="font-size: 11px; font-weight: bold; width: 20px">
                                                    FİRE AĞIRLIĞI (kg)
                                                </td>

                                            </tr>
                                            <tr style="background-color: #edf0f5 ">
                                                <th class="text-center p-1" style="font-size: 11px; font-weight: bold; width: 20px">
                                                    FİRE
                                                </th>
                                                <td class="text-center p-1">
                                                    <input class="border-0 text-center" style="width:80px;background-color:transparent" id="fireyuzde" keyup="updateinput(this.value)" readonly="">
                                                </td>
                                                <td class="text-center p-1">
                                                    <input class="border-0 text-center" style="width: 80px; background-color: transparent" id="fireagir" readonly="">
                                                </td>
                                                <td class="text-center p-1">
                                                    <input class="border-0 text-center" style="width: 80px; background-color: transparent" id="fireagirligi" readonly="">
                                                </td>

                                            </tr>
                                            <tr style="background-color: #e8ebeb ">

                                                <th class="text-center p-1" style="font-size: 11px; font-weight: bold; width: 20px">
                                                    GENEL FİRE
                                                </th>
                                                <td class="text-center p-1">
                                                    <input class="border-0 text-center" style="width:80px;background-color:transparent" id="fireyuzde1" readonly="">
                                                </td>
                                                <td class="text-center p-1">
                                                    <input class="border-0 text-center" style="width: 80px; background-color: transparent" id="fireagir1" readonly="">
                                                </td>
                                                <td class="text-center p-1">
                                                    <input class="border-0 text-center" style="width: 80px; background-color: transparent" id="fireagirligi1" readonly="">
                                                </td>

                                            </tr>
                                        </tbody>
                                    </table>

                                </div>
                            </div>

                            <div class="col-6">
                                <div class="row me-1">
                                    <div class="col">
                                        <button class="float-end" onclick="addRow()" id="addRw" style="cursor: pointer; background-color: transparent; background-repeat: no-repeat; border: none;"><img style="width:20px" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACQAAAAkCAYAAADhAJiYAAAAAXNSR0IArs4c6QAAAmlJREFUWEftmOFxFDEMhd9VQKiApAJIBUkHQAVABZAKQiogVABUAHRAKiCpINABVEDmu7FuhM5ey3s3zE4G/dm5W9l6lp7l511pYbZaGB7dG0BPJL2QxPOgPEn2taRf5fmpPIeKMJqht5JeFxCZQIC7lHSRccYnC+iZpHeSDrMTB78fks4kfemNzwAiK+dhop9l8m+SCEapMEoI6FNJLOJRGMdck9nqAfpYuGLzAoRJ+T9jL4u/B8bYV63BU4BiZr5KIgC8GDFID4inbhBZYv4tawEi3Z+dNzsGMLtYzPbzGqdagOCFpZnMALBl8OWkvLySBK9aBqktU8Q4io41QL5UcAaiTpXJ+zdLUQJTPoA8KL+3/GuACG4DIF+PwCOAwEHpPxRAxHrosxQBkY3vxYHsZPrOKCCm95Q49h09AqKr0omx95LeJFg8B1AzTgQEIY2g1V1QATgHkN/FbAQ2xtoiIDru4/Lur1SWQQbW42Iym5AF1XZZ3H2eGsQkVhXQHxcpgq0dIYmKrl1qu68aKwZdHKBeyTa1dqnJNMZYSl+yG6entji0OFIvbtv7VFbPmj1t+3RjJN6/PDp+RzncO1xZCT1in4frrQOROlzjWYNkoGu3LNMYbayXH9WzMivQJmVnsjvuJNCIETszq0OOzJGwyA0v8oYlrC06rgpOARRJmzG0D9cnhJnZpBzu3TpqmTKOkTEaKVzw1yCkr12Dop7qKcqhiyJNM96zMlnCB9Boq71cFH1QysXEJnF7gOgzLKR65akNzpSsNo6ODj/sY4NpKA5K+9gA/6yUPeCb93MBpQOMOv4H1MvYHYPjoiWLe0qnAAAAAElFTkSuQmCC"></button>
                                        <button class="float-end" onclick="removeRow()" id="removeRw" style="cursor: pointer; background-color: transparent; background-repeat: no-repeat; border: none;"><img style="width:20px" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABgAAAAYCAYAAADgdz34AAAAAXNSR0IArs4c6QAAAVJJREFUSEu9leFRwzAMhb9OAkwAnQBGgAlgA+gkwATABMAGMAGwQZkE7uOsnuMmscOl1Z1/xFb09GTpecGObbHj+LQAXAGnwEla5vSZ1gvwOpbkGMA5cAscVliugRUg2JYNAdwB18n7G/D7LWXttmzOgBvgIPnpI1DH+gDy4P7g95gJIlPtPoFu/EsAy/KcTpdZxrVekNFHcrrIy1UCWE8pt2ReggYTYxzFYQ5gtzwA1rx2sUOMIsENixzgEbj8Z/YBGCyeABPuzIG9fQxMqX3JJO7CWMbpAPwk75xV7NUuue+fv73BgxRxVoA5S/QVsrLXS44h6/RxrfjF+Wib6jvHoHXmaO9SIYtc7BwcBWw2sYtAOYhl8/u9kGsfIRMIWdlS0nIOyiy9dAOH3g+xsOYCTXpw8mACuZQBpUSzz50bg/YG7lPTiR3Z5t7y6LdFGvD6BU/pUBk06brSAAAAAElFTkSuQmCC"></button>
                                    </div>
                                </div>
                                <div class="row mt-3 me-1">
                                    <div class="col">
                                        <button class="btn btn-info float-start" style="background-image: linear-gradient(to right, #E0EAFC 0%, #CFDEF3 51%, #E0EAFC 100%);color:black;font-size:11px" onclick="kaydet()" id="kaydet">KAYDET</button>
                                        <button class="btn btn-info float-start ms-1" style="background-image: linear-gradient(to right, #E0EAFC 0%, #CFDEF3 51%, #E0EAFC 100%);color:black;font-size:11px" onclick="tablosil()" id="kaydet">SİL</button>
                                    </div>

                                </div>



                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- #endregion -->
        <div class="row mt-2">
            <div class="col text-end">
                <button class="btn btn-info" style="background-image: linear-gradient(to right, #E0EAFC 0%, #CFDEF3 51%, #E0EAFC 100%);color:black;font-size:11px" onclick="sil()" id="sil"><i class='bx bx-trash'> SİL</i></button>
                <button class="btn btn-info text-nowrap" style="background-image: linear-gradient(to right, #E0EAFC 0%, #CFDEF3 51%, #E0EAFC 100%);color:black;font-size:11px" onclick="netsisaktar()"><i class='bx bx-transfer'></i> NETSİSE AKTAR</button>
            </div>
        </div>
        <div class="table-responsive mt-3" style="max-height:33vh !important">

            <div class="row me-0">
                <div class="col">




                    <div class="text-center" id="DLPivot2"></div>





                </div>
            </div>


            <div class="row mb-2 me-0">


                <div class="col">

                    <div class="text-center mt-3" id="DLPivot"></div>


                </div>



            </div>
        </div>
    </div>
    @Html.Partial("IsEmriPartials/RehberPartial")
<script>

        if ($(window).width() < 600) {
            $("#divPartial2").show();
        }
        else {
            $("#divPartial").show();

        }
        function rehberAc() {

            $("#rehberSec").modal("show");
            $("#urunler").bootstrapTable("destroy").bootstrapTable({
                url: 'http://192.168.2.13:83/api/seri/serirehber'
            }).on('click-row.bs.table', function (e, row, $element) {
                $("#seri").val(row.SERI_NO).trigger("input");
                $("#rehberSec").modal("hide");
                inputHandler();
            });

        }
        function ModalKapat() {
            $("#rehberSec").modal("hide");
        }
        const seri = document.getElementById('seri');
        const genislik = document.getElementById('genislik');
        const genislikarti = document.getElementById('genislikalti');
        const kalinlik = document.getElementById('kalinlik');
        const agirlik = document.getElementById('agirlik');
        const marka = document.getElementById('marka');
        const adet = document.getElementById('adet');
        const kaplama = document.getElementById('kaplama');
        const stokAdi = document.getElementById('stokadi');
        const kalite = document.getElementById('kalite');
        const hamoran = document.getElementById('hamoran');

         function rechange() {
            $.getJSON("http://192.168.2.13:83/api/seri/serirehber", function (data) {
                jsonObj = data;
            }).done(function () {
                var b = jsonObj.find(x => x.SERI_NO === seri.value);
                var top = 0;

                if (localStorage.DLlist != "null" && localStorage.DLlist != null) {
                    var j = JSON.parse(localStorage.DLlist);
                    var son = j.filter(x => x.GIRDI1 == seri.value);
                    if (son.length > 0) {
                        var s = [];
                        for (let i = 0; i < son.length; i++) {
                            if (!s.includes(son[i].HAMORAN)) {
                                s.push(son[i].HAMORAN)
                            }
                        }
                        if (s.length > 1) {
                            top = eval(s.join('+'));
                        } else {
                            top = s[0];
                        }


                    }

                }

                hamoran.value = (1 - top).toFixed(4);
                ham.oninput = function () {
                    if (this.value >= 1 - top) {
                        this.value = ((1 - top).toFixed(4)).toString();
                    } else if (this.value < 0) {
                        this.value = 0;
                    }
                };

                if (b != null) {
                    kalinlik.value = b.ACIK2;
                    genislik.value = b.ACIK1;
                    agirlik.value = (b.MIKTAR * hamoran.value).toLocaleString('tr-TR') + " / " + (b.MIKTAR).toLocaleString('tr-TR');
                    marka.innerHTML = b.MENSEI;
                    adet.value = b.MIKTAR2;
                    kaplama.value = b.SERI_NO_4;
                    kalite.value = b.SERI_NO_3;
                    stokAdi.innerHTML = b.STOK_ADI;
                    metraj.value = parseFloat((parseInt(b.MIKTAR * hamoran.value)) / ((parseInt(b.ACIK1) + parseInt(document.getElementById('genislikalti').value)) * parseFloat((b.ACIK2).replace(",", ".")) * (0.00786))).toFixed(2) + " / " + parseFloat(parseInt((b.MIKTAR)) / ((parseInt(b.ACIK1) + parseInt(document.getElementById('genislikalti').value)) * parseFloat((b.ACIK2).replace(",", ".")) * (0.00786))).toFixed(2);
                    var alltr = document.getElementsByTagName("table")[1].getElementsByTagName("tr");



                }
                else {
                    genislik.value = "";
                    kalinlik.value = "";
                    agirlik.value = "";
                    marka.innerHTML = "";
                    adet.value = "";
                    kaplama.value = "";
                    stokAdi.innerHTML = "";
                    kalite.value = "";
                    $("#metraj").val("");
                }


                var tr = document.getElementById("DLTable").getElementsByTagName("tr");
                for (let i = 1; i < tr.length; i++) {
                    tr[i].getElementsByTagName("input")[0].onblur();
                }
                if (top != 0) {
                    const Toast = Swal.mixin({
                        toast: true,
                        position: 'top-end',
                        showConfirmButton: false,
                        timer: 3000,
                        timerProgressBar: true,
                        didOpen: (toast) => {
                            toast.addEventListener('mouseenter', Swal.stopTimer)
                            toast.addEventListener('mouseleave', Swal.resumeTimer)
                        }
                    })
                    if ((1 - top) == 0) {
                        Toast.fire({
                            icon: 'error',
                            title: 'Ürün kullanılabilir değil!'
                        });
                        document.getElementById("kaydet").disabled = true;
                    } else {
                        Toast.fire({
                            icon: 'info',
                            title: 'Ürün maksimum %' + (((1 - top).toFixed(4)) * 100) + ' oranında kullanılabilir!'
                        });
                        $("#kaydet").attr("disabled", true)

                    }

                } else {
                    $("#kaydet").attr("disabled", false)
                }
                if (b != null) {
                    $("#kaydet").attr("disabled", false)
                } else {
                    $("#kaydet").attr("disabled", true)
                }


            })




    }
    var DLlist = null;
    var DLTopList = null;
    var serilist = [];
    var isemrilist = [];
    var siralist = [];
    var say = 0;
    var tp = 0;
    var sonSeri = null;
    var takiplist = [];
    var DLList = null;
        $(document).ready(function () {
            $(".js-select").select2();
            $("#btnradio12").prop("checked", true);
            var tpl = $.pivotUtilities.aggregatorTemplates;
            function drawPivot() {

                $(function () {
                    $("#DLPivot").pivot(
                        takiplist,
                        {
                            rows: ["GIRDI1", "GIRDI2", "ISEMRINO", "STOKADI", "KALINLIK", "KALITE", "KAPLAMA", "GENISLIK", "ADET", "REF_ISEMRINO", "REF_STOKOLCUSU", "REF_ADET", "AGIRLIK", "FIRE", "HAMSARF"],
                            cols: [],
                            aggregator: tpl.sum()(["ADET"]),
                            sorters: {

                                GIRDI1: function (a, b) { return a - b; } //sort backwards
                            }


                        }, false, "tr")
                })
            }
            function getPivot() {
                return fetch('./Index?handler=PivotData',
                    {
                        method: 'get',
                        headers: {
                            'Content-Type': 'application/json;charset=UTF-8'
                        }
                    }).then(function (response) {
                        if (response.ok) { return response.text(); } else { throw Error("Hata"); }
                    }).then(function (text) {
                        try {
                            return JSON.parse(text);
                        } catch (e) {

                        }
                    }).then(function (responseJSON) {
                        document.body.style.cursor = 'default';
                        takiplist = JSON.parse(localStorage.DLlist);
                        var girdi1 = [];
                        for (let i = 0; i < takiplist.length; i++) {

                            if (!girdi1.includes(takiplist[i].GIRDI1)) {

                                girdi1.push({ GIRDI1: takiplist[i].GIRDI1 });

                            }

                        }

                        var newtakip = [];
                        var hamtop = 0;
                        var firtop = 0;
                        for (let i = 0; i < girdi1.length; i++) {
                            var sum = 0;
                            var fil = takiplist.filter(x => x.GIRDI1 == girdi1[i].GIRDI1);

                            for (let e = 0; e < fil.length; e++) {
                                sum = sum + parseFloat(fil[e].GENISLIK);
                            }
                            var ek = 0;
                            for (let e = 0; e < fil.length; e++) {
                                fil[e].HAMSARF = parseFloat(parseFloat(fil[e].GENISLIK) / sum) * (parseFloat(fil[e].TAMAGIRLIK));
                                var oldek = ek;
                                ek = ek + fil[e].HAMSARF - parseInt(fil[e].HAMSARF);
                                if (Math.round(ek) != Math.round(oldek)) {
                                    fil[e].HAMSARF = parseInt(fil[e].HAMSARF) + 1;
                                } else {
                                    fil[e].HAMSARF = parseInt(fil[e].HAMSARF)
                                }
                                fil[e].FIRE = fil[e].HAMSARF - (parseFloat(fil[e].AGIRLIK));
                                fil[e].AGIRLIK = parseInt(parseFloat(fil[e].AGIRLIK));
                            }

                            if (newtakip.length == 0) {
                                newtakip = fil;
                            } else {
                                newtakip = newtakip.concat(fil);
                            }

                        }
                        takiplist = newtakip;
                        var fn = takiplist.filter(x => x.ISEMRINO === takiplist[0].ISEMRINO).length;
                        for (let i = 0; i < takiplist.length; i++) {
                            tp = tp + parseInt(takiplist[i].FIRE);
                        }

                        for (let i = 0; i < takiplist.length; i++) {
                            hamtop = hamtop + takiplist[i].HAMSARF;
                            firtop = firtop + takiplist[i].FIRE;
                        }
                        //fireag.value = (firtop / fn).toLocaleString();
                        //fireyuz.value = ((firtop / fn) / (hamtop / fn) * 100).toFixed(2) + " %";
                        localStorage.list4 = JSON.stringify(takiplist);
                        drawPivot();
                    });



            }
            if (localStorage.DLlist != "null" && localStorage.DLlist != null) {
                getPivot();
            }
        })
    function MachineChange(val) {
        if (val.value != "MAKİNE SEÇİN") {
            document.getElementById("DLTable").getElementsByTagName("tr")[val.parentNode.parentNode.rowIndex].getElementsByTagName("select")[1].removeAttribute("disabled");
            $.getJSON("http://192.168.2.13:83/api/ie/besleme", function (data) {
                var d = data.filter(x => x.HAT_KODU == val.value);
                $(".selectmakina2").select2('destroy');
                if (document.getElementById("DLTable").getElementsByTagName("tr")[val.parentNode.parentNode.rowIndex].getElementsByTagName("select")[2].value == "MAKİNE SEÇİN") {
                    

                    var $sel2 = document.getElementById("DLTable").getElementsByTagName("tr")[val.parentNode.parentNode.rowIndex].getElementsByTagName("select")[2];
                    $sel2.replaceChildren();
                    var opt = document.createElement("option");
                    opt.value = "MAKİNE SEÇİN";
                    opt.text = "MAKİNE SEÇİN";
                    opt.setAttribute("selected", "");
                    opt.setAttribute("disabled", "");
                    $sel2.appendChild(opt);
                    for (let i = 0; i < d.length; i++) {
                        var opt1 = document.createElement("option");
                        opt1.value = d[i].HAT_KODU2;
                        opt1.text = d[i].HAT_KODU2;
                        $sel2.appendChild(opt1);
                    }
                    
                }
                $(".selectmakina2").select2();
            })
        }
        }
    function RefMachineChange(val) {
        if (val.value != "MAKİNE SEÇİN") {

            document.getElementById("DLTable").getElementsByTagName("tr")[val.parentNode.parentNode.rowIndex].getElementsByTagName("select")[3].removeAttribute("disabled");
        }
        }
        function DlInputChange(val) {
            var tr = document.getElementById("DLTable").getElementsByTagName("tr")[val.parentNode.parentNode.rowIndex];
            tr.getElementsByTagName("td")[11].getElementsByTagName("input")[0].value = parseFloat((parseInt(tr.getElementsByTagName("td")[4].getElementsByTagName("input")[0].value) * parseInt(tr.getElementsByTagName("td")[5].getElementsByTagName("input")[0].value)) / ((parseInt(document.getElementById("genislik").value)) + (parseInt(document.getElementById("genislikalti").value))) * (parseInt(document.getElementById("agirlik").value.split('/')[0].split('.')[0] + document.getElementById("agirlik").value.split('/')[0].split('.')[1])) * parseFloat(tr.getElementsByTagName("td")[1].getElementsByTagName("input")[0].value.toString().replace(",", ".")));
            tr.getElementsByTagName("td")[11].getElementsByTagName("input")[1].value = parseInt(tr.getElementsByTagName("td")[11].getElementsByTagName("input")[0].value)
            var top1 = 0;
            var rows = document.getElementById("DLTable").getElementsByTagName("tr");
            for (let i = 1; i < rows.length; i++) {
                if (rows[i].getElementsByTagName("td")[4].getElementsByTagName("input")[0].value != "") {
                    top1 = top1 + (parseInt(rows[i].getElementsByTagName("td")[4].getElementsByTagName("input")[0].value) * parseInt(rows[i].getElementsByTagName("td")[5].getElementsByTagName("input")[0].value) * parseFloat(rows[i].getElementsByTagName("input")[0].value));
                }
            }
            var d = parseInt(((parseInt(document.getElementById("genislik").value)) + (parseInt(document.getElementById("genislikalti").value))) - top1);
            document.getElementById("fireagir").value = d;
            document.getElementById("fireyuzde").value = parseFloat((parseFloat(document.getElementById("fireagir").value) / ((parseInt(document.getElementById("genislik").value)) + (parseInt(document.getElementById("genislikalti").value)))) * 100).toFixed(2) + " %";

            document.getElementById("fireagirligi").value = ((parseFloat(document.getElementById("fireagir").value) / ((parseInt(document.getElementById("genislik").value)) + (parseInt(document.getElementById("genislikalti").value)))) * (parseInt(document.getElementById("agirlik").value.split('/')[0].split('.')[0] + document.getElementById("agirlik").value.split('/')[0].split('.')[1]))).toFixed(2);
        }
        function RefStokChange(val) {
            var tr = document.getElementById("DLTable").getElementsByTagName("tr")[val.parentNode.parentNode.rowIndex];
            var jsonObj = @Html.Raw(Json.Encode(ViewBag.Stok_Adlari));
            var oo = jsonObj.find(x => x.STOK_ADI == val.value);
            var m = document.getElementById("metraj").value;
            var upt = m.split('/')[0];
            var o = parseFloat(tr.getElementsByTagName("input")[0].value);
            tr.getElementsByTagName("td")[9].innerHTML = Math.round((parseFloat(upt) / (oo.BOY / 1000)) * o);
    }
    function oran(val) {
        var tr = document.getElementById("DLTable").getElementsByTagName("tr")[val.parentNode.parentNode.parentNode.rowIndex];
        if (val.value > 1) {
            val.value = "1.00"
        } else if (val.value <= 0) {
            val.value = "0.01"
        }

        DlInputChange(tr.getElementsByTagName("td")[4].getElementsByTagName("input")[0]);
        $(".js-select").trigger("change");
    }
    function addRow() {
        var table = document.getElementById("DLTable")
        var totaltr = table.getElementsByTagName("tr");
        var tr = document.createElement("tr");
        $('.js-select').select2("destroy");
        var totaltd = totaltr[1].getElementsByTagName("td").length;
        for (let i = 0; i < totaltd; i++) {
            var td = document.createElement("td");
            td.style = table.getElementsByTagName("tr")[totaltr.length - 1].getElementsByTagName("td")[i].getAttribute("style");
            td.className = table.getElementsByTagName("tr")[totaltr.length - 1].getElementsByTagName("td")[i].className;
            td.innerHTML = table.getElementsByTagName("tr")[totaltr.length - 1].getElementsByTagName("td")[i].innerHTML;
            tr.appendChild(td);
            if (i == 9) {
                td.replaceChildren();
            }
            if (i == 0) {
                td.innerHTML = parseInt(td.innerHTML)+1;
            }
        }
        table.getElementsByTagName("tbody")[0].appendChild(tr);
        $('.js-select').select2();
    }
    function removeRow() {
        var table = document.getElementById("DLTable")
        var totaltr = table.getElementsByTagName("tr");
        if (totaltr.length > 2) {
            totaltr[totaltr.length - 1].remove();
        }

    }
    
    function kaydet() {
        $.getJSON("http://192.168.2.13:83/api/seri/exec/1", function (data) {
            sonSeri = data;
        }).done(function () {
             var jsonObj = @Html.Raw(Json.Encode(ViewBag.SIRANO));
                var table = document.getElementById("DLTable");
            var tr = table.getElementsByTagName("tr");
            if (localStorage.DLlist != null && localStorage.DLlist != "null") {
                DLList = JSON.parse(localStorage.DLlist)
                for (let e = 0; e < DLList.length; e++) {
                    if (!serilist.includes(DLList[e].GIRDI2)) {
                        serilist.push(DLList[e].GIRDI2);
                    }

                    if (!isemrilist.includes(DLList[e].ISEMRINO)) {
                        isemrilist.push(DLList[e].ISEMRINO);
                    }

                    if (!isemrilist.includes(DLList[e].REF_ISEMRINO)) {
                        isemrilist.push(DLList[e].REF_ISEMRINO);
                    }

                }
            } else {
                DLList = [];
            }
            for (let i = 1; i < tr.length; i++) {
                var adet = tr[i].getElementsByTagName("td")[5].getElementsByTagName("input")[0].value;
               
                for (let a = 0; a < adet; a++) {
                    
                    var tam = document.getElementById("agirlik").value.split("/")[0].split('.').join('');
                    var hamor = document.getElementById("hamoran").value;
                    var sirano = parseInt(tr[i].getElementsByTagName("td")[0].innerHTML);
                    var girdi2 = sonSeri[0].SERI_NO;
                    var makine = tr[i].getElementsByTagName("select")[0].value;
                    var makineref = tr[i].getElementsByTagName("select")[2].value;
                    var s = jsonObj.filter(x => x.MAK_KODU == makine);
                    var s1 = jsonObj.filter(x => x.MAK_KODU == makineref);
                    var urunkodu = document.getElementById("seri").value;
                    var sonisemri = makine + "23" + (s[s.length - 1].MAX_ISEMRINO).toString().padStart(6, '0') + (a + 1).toString().padStart(3, '0');
                    var stokadi = tr[i].getElementsByTagName("select")[1].value;
                    var kalinlik = document.getElementById("kalinlik").value;
                    var kaplama = document.getElementById("kaplama").value;
                    var kalite = document.getElementById("kalite").value;
                    var siparisno = "";
                    var genislik = tr[i].getElementsByTagName("td")[4].getElementsByTagName("input")[0].value;

                    var refagirlik = tr[i].getElementsByTagName("td")[11].getElementsByTagName("input")[0].value;
                    var refadet = tr[i].getElementsByTagName("td")[9].innerHTML;
                    var refstokolcusu = tr[i].getElementsByTagName("select")[3].value;
                    var sonrefisemri = "-";
                    if (s1.length>0) {
                        sonrefisemri = makineref + "23" + (s1[s1.length - 1].MAX_ISEMRINO).toString().padStart(6, '0') + (a + 1).toString().padStart(3, '0');
                        if (isemrilist.includes(sonrefisemri)) {
                            var is1 = isemrilist.filter(x => x.includes(makineref));
                            sonrefisemri = is1[is1.length - 1].substring(0, 12) + (parseInt(is1[is1.length - 1].substring(12, 15)) + 1).toString().padStart(3, '0');
                        }
                    }
                        

                    if (isemrilist.includes(sonisemri)) {
                        var is = isemrilist.filter(x => x.includes(makine));
                        sonisemri = is[is.length - 1].substring(0, 12) + (parseInt(is[is.length - 1].substring(12, 15)) + 1).toString().padStart(3, '0');
                    }

                    if (serilist.includes(girdi2)) {
                        if (siralist.includes(sirano) && adet == 1) {
                            girdi2 = serilist[serilist.length - 1];
                        } else {
                            girdi2 = girdi2.substring(0, 12) + (parseInt(serilist[serilist.length - 1].substring(12, 15)) + 1).toString().padStart(3, '0');
                        }

                    }
                    if (refstokolcusu == "STOK SEÇİN") {
                        refstokolcusu = "-"
                        refadet = "-"
                    } else {
                        refadet = Math.round(refadet / adet)
                    }
                   
                    DLList.push({
                        GIRDI1: urunkodu, GIRDI2: girdi2, ISEMRINO: sonisemri, STOKADI: stokadi, KALINLIK: kalinlik, KALITE: kalite, KAPLAMA: kaplama, GENISLIK: genislik, ADET: 1, REF_ISEMRINO: sonrefisemri, REF_STOKOLCUSU: refstokolcusu, REF_ADET: refadet, AGIRLIK: (parseFloat(refagirlik) / adet).toString(), SIPKONT: "", SIPARISNO: siparisno, HAMORAN: hamor, TAMAGIRLIK: tam
                    });
                    
                    if (!serilist.includes(girdi2)) {

                        serilist.push(girdi2);
                    }
                    if (!siralist.includes(sirano)) {

                        siralist.push(sirano);
                    }
                    isemrilist.push(sonisemri);

                    if (sonrefisemri != "-") {
                        isemrilist.push(sonrefisemri);
                    }
                  
                    
                    say++;
                }
                localStorage.DLlist = JSON.stringify(DLList);

            }
            var tpl = $.pivotUtilities.aggregatorTemplates;
            takiplist = [];

            function drawPivot() {

                $(function () {
                    document.getElementById("DLPivot").replaceChildren();
                    $("#DLPivot").pivot(
                        takiplist,
                        {
                            rows: ["GIRDI1", "GIRDI2", "ISEMRINO", "STOKADI", "KALINLIK", "KALITE", "KAPLAMA", "GENISLIK", "ADET", "REF_ISEMRINO", "REF_STOKOLCUSU", "REF_ADET", "AGIRLIK", "FIRE", "HAMSARF"],
                            cols: [],
                            aggregator: tpl.sum()(["ADET"]),
                            sorters: {

                                GIRDI1: function (a, b) { return a - b; } //sort backwards
                            }


                        }, false, "tr")
                })
            }
            function getPivot() {
                return fetch('./Index?handler=PivotData',
                    {
                        method: 'get',
                        headers: {
                            'Content-Type': 'application/json;charset=UTF-8'
                        }
                    }).then(function (response) {
                        if (response.ok) { return response.text(); } else { throw Error("Hata"); }
                    }).then(function (text) {
                        try {
                            return JSON.parse(text);
                        } catch (e) {

                        }
                    }).then(function (responseJSON) {
                        document.body.style.cursor = 'default';
                        takiplist = JSON.parse(localStorage.DLlist);
                        var girdi1 = [];
                        for (let i = 0; i < takiplist.length; i++) {

                            if (!girdi1.includes(takiplist[i].GIRDI1)) {

                                girdi1.push({ GIRDI1: takiplist[i].GIRDI1 });

                            }

                        }
                        
                        var newtakip = [];
                        var hamtop = 0;
                        var firtop = 0;
                        for (let i = 0; i < girdi1.length; i++) {
                            var sum = 0;
                            var fil = takiplist.filter(x => x.GIRDI1 == girdi1[i].GIRDI1);

                            for (let e = 0; e < fil.length; e++) {
                                sum = sum + parseFloat(fil[e].GENISLIK);
                            }
                            var ek = 0;
                            for (let e = 0; e < fil.length; e++) {
                                fil[e].HAMSARF = parseFloat(parseFloat(fil[e].GENISLIK) / sum) * (parseFloat(fil[e].TAMAGIRLIK));
                                var oldek = ek;
                                ek = ek + fil[e].HAMSARF - parseInt(fil[e].HAMSARF);
                                if (Math.round(ek) != Math.round(oldek)) {
                                    fil[e].HAMSARF = parseInt(fil[e].HAMSARF) + 1;
                                } else {
                                    fil[e].HAMSARF = parseInt(fil[e].HAMSARF)
                                }
                                fil[e].FIRE = fil[e].HAMSARF - (parseFloat(fil[e].AGIRLIK));
                                fil[e].AGIRLIK = parseInt(parseFloat(fil[e].AGIRLIK));
                            }

                            if (newtakip.length == 0) {
                                newtakip = fil;
                            } else {
                                newtakip = newtakip.concat(fil);
                            }

                        }
                        
                        takiplist = newtakip;
                        var fn = takiplist.filter(x => x.ISEMRINO === takiplist[0].ISEMRINO).length;
                        for (let i = 0; i < takiplist.length; i++) {
                            tp = tp + parseInt(takiplist[i].FIRE);
                        }

                        for (let i = 0; i < takiplist.length; i++) {
                            hamtop = hamtop + takiplist[i].HAMSARF;
                            firtop = firtop + takiplist[i].FIRE;
                        }
                        //fireag.value = (firtop / fn).toLocaleString();
                        //fireyuz.value = ((firtop / fn) / (hamtop / fn) * 100).toFixed(2) + " %";
                        localStorage.list4 = JSON.stringify(takiplist);
                        drawPivot();
                    });



            }

            var takiplist2 = [];
            var aggMap = {
                'agg1': {
                    aggType: 'Sum',
                    arguments: ['ADET'],
                    name: 'ADET TOPLAM',
                    varName: 'a',
                    renderEnhancement: 'barchart'
                },

                'agg2': {
                    aggType: 'Sum',
                    arguments: ['AGIRLIK'],
                    name: 'AGIRLIK TOPLAM',
                    varName: 'b',
                    hidden: false,
                    renderEnhancement: 'none'
                },

            };


            var customAggs = {};
            customAggs['Multifact Aggregators'] = $.pivotUtilities.multifactAggregatorGenerator(aggMap, []);

            var config = {
                "cols": [],
                "rows": ["MUSTERI", "STOKOLCULERI", "KALINLIK", "KALITE", "KAPLAMA"],
                "vals": [],
                "rowOrder": "key_a_to_z",
                "colOrder": "key_a_to_z",
                "aggregatorName": "Multifact Aggregators",
                "rendererName": "GT Table Heatmap and Barchart",
                "rendererOptions": {

                    aggregations: {
                        defaultAggregations: aggMap,


                    }
                }
            };




            $.pivotUtilities.customAggs = customAggs;

            config.aggregators = $.extend($.pivotUtilities.aggregators, $.pivotUtilities.customAggs);

            config.renderers = $.extend($.pivotUtilities.renderers, $.pivotUtilities.gtRenderers);
            getPivot();
        })


    }
    function sil() {
        localStorage.DLlist = null;
        document.getElementById("DLPivot").replaceChildren();
    }
    function c(val) {
        if (val.value == "DL") {
            $("#DLTable").show();
            $("#DLPivot").show();
            $("#table1").show();
        } else {
            $("#DLTable").hide();
            $("#DLPivot").hide();
            $("#table1").hide();
        }
    }
</script>
</body>
</html>






