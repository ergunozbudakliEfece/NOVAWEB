<div class="modal fade" id="SevkFormBelge" data-bs-backdrop="static" data-bs-keyboard="false" aria-labelledby="SevkFormBelgeLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable full-modal">
        <div class="modal-content modal-belge" style="box-shadow: inset 0 0 15px #dbdbdb;">

            <div class="modal-header ml-auto mr-auto">
                <h5 class="modal-title text-center w-100" id="SevkFormBelgeLabel">BELGE LİSTESİ</h5>
                <button type="button" class="ds btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>

            <div class="modal-body  py-2">
                <div class="container-fluid">
                    <div class="centercontent" id="content" style="display:flex;justify-content:center;">
                        <div class="heart"><img id="DepoTransferBelgeTableProgress" src="~/images/novasaydam.png" style="max-width:10vw" /></div>
                    </div>

                    <div class="row gy-3 my-2" id="DepoTransferBelgeTableToolbar">
                        <div class="row mb-2 gy-2">
                            <div class="col-sm-auto">
                                <div class="btn-group" role="group" aria-label="Basic radio toggle button group">
                                    <input type="radio" class="btn-check" onclick="DurumSecim();" name="DocumentStateRadio" id="ACIK_BUTTON" value="true" checked="" autocomplete="off">
                                    <label class="btn btn-outline-primary" for="ACIK_BUTTON">AÇIK</label>
                                    <input type="radio" class="btn-check" onclick="DurumSecim();" name="DocumentStateRadio" id="KAPALI_BUTTON" value="false" autocomplete="off">
                                    <label class="btn btn-outline-primary" for="KAPALI_BUTTON">KAPALI</label>
                                    <input type="radio" class="btn-check" onclick="DurumSecim();" name="DocumentStateRadio" id="TUMU_BUTTON" value="all" autocomplete="off">
                                    <label class="btn btn-outline-primary" for="TUMU_BUTTON">TÜMÜ</label>
                                </div>
                            </div>
                            <div class="col-sm-auto">
                                <button type="button" id="refreshButton" class="btn btn-icon btn-outline-primary" onclick="VerileriGetir()" data-bs-toggle="tooltip" data-popup="tooltip-custom" data-bs-placement="right" data-bs-html="true" data-bs-original-title="<span>Yenile</span>">
                                    <span class="tf-icons bx bx-refresh" style="font-size:x-large;"></span>
                                </button>
                            </div>
                            <div class="col d-flex justify-content-start gap-2">
                                <div class="d-flex justify-content-center align-items-center mx-2"><div style="width: 1.25rem; height: 1.25rem; background-color: #e9ebff; margin-right: 0.2rem; "></div>AÇIK</div>
                                <div class="d-flex justify-content-center align-items-center"><div style="width: 1.25rem; height: 1.25rem; background-color: #FAEAEA; margin-right: 0.2rem; "></div>KAPALI</div>
                            </div>
                        </div>
                    </div>

                    <div id="DepoTransferBelgeTableRow" class="row mb-2 gy-2">
                        <div class="table-responsive">
                            <table id="DepoTransferBelgeTable"
                                   data-search="true"
                                   data-show-refresh="false"
                                   data-show-toggle="false"
                                   data-show-fullscreen="false"
                                   data-show-columns="false"
                                   data-show-columns-toggle-all="false"
                                   data-detail-view="true"
                                   data-detail-view-by-click="true"
                                   data-show-export="false"
                                   data-click-to-select="true"
                                   data-minimum-count-columns="2"
                                   data-show-pagination-switch="false"
                                   data-page-size="5"
                                   data-pagination="true"
                                   data-id-field="id"
                                   data-show-footer="false"
                                   data-mobile-responsive="true"
                                   data-response-handler="responseHandler"
                                   data-pagination-parts="['pageSize', 'pageInfo', 'pageList']"
                                   data-locale="tr-TR"
                                   data-row-style="DetailSatirStili">
                                <thead>
                                    <tr>
                                        <th data-field="BELGE_NO" data-sortable="true" data-halign="center" data-align="center">BELGE NO</th>
                                        <th data-field="PLAKA" data-sortable="true" data-halign="center" data-align="center" data-filter-control="input">PLAKA</th>
                                        <th data-field="SOFOR" data-sortable="true" data-halign="center" data-align="center" data-filter-control="input">SOFOR</th>
                                        <th data-formatter="BelgeDurumuFormatter" data-sortable="true" data-field="ACTIVE" data-halign="center" data-align="center">BELGE DURUMU</th>
                                        <th data-formatter="BelgeListIslemFormatter" data-halign="center" data-align="center">İŞLEM</th>
                                    </tr>
                                </thead>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    var DuzenlenmemisBelgeler = [];
    var DuzenlenmisBelgeler = [];
    var BELGE_NO;

    function BelgeListesi() {
        DuzenlenmemisBelgeler = [];
        DuzenlenmisBelgeler = [];

        VerileriGetir();

        $('#DepoTransferBelgeTable').bootstrapTable('destroy');
        $('#DepoTransferBelgeTable').bootstrapTable({ data: [] });

        $('#SevkFormBelge').modal('show');
    }

    function VerileriGetir() {
        $("#DepoTransferBelgeTableProgress").show();
        $("#DepoTransferBelgeTableRow").hide();
        $("#DepoTransferBelgeTableToolbar").hide();

        $('#ACIK_BUTTON').prop('checked', true);
        var ProcUrl = "http://192.168.2.13:83/api/shipping/sip/0";

        $.getJSON(ProcUrl, function (data) {
            if (data.length > 0) {
                DuzenlenmemisBelgeler = data;

                var BelgoNoFiltreli = data.filter(
                    (obj, index) =>
                        data.findIndex((item) => item.BELGE_NO === obj.BELGE_NO) === index
                );

                DuzenlenmisBelgeler = [];

                for (var i = 0; i < BelgoNoFiltreli.length; i++) {
                    var Filtered = data.filter(x => x.BELGE_NO == BelgoNoFiltreli[i].BELGE_NO);
                    var AcikMi = false;

                    for (var j = 0; j < Filtered.length; j++) {
                        if (Filtered[j].ACTIVE) {
                            DuzenlenmisBelgeler.push({
                                "CARI_ISIM": BelgoNoFiltreli[i].CARI_ISIM,
                                "SIPARIS_NO": BelgoNoFiltreli[i].SIPARIS_NO,
                                "PLAKA": BelgoNoFiltreli[i].PLAKA,
                                "SOFOR": BelgoNoFiltreli[i].SOFOR,
                                "BELGE_NO": BelgoNoFiltreli[i].BELGE_NO,
                                "ACTIVE": true,
                            });
                            AcikMi = true;
                            break;
                        }
                    }

                    if (!AcikMi) {
                        DuzenlenmisBelgeler.push({
                            "CARI_ISIM": BelgoNoFiltreli[i].CARI_ISIM,
                            "SIPARIS_NO": BelgoNoFiltreli[i].SIPARIS_NO,
                            "PLAKA": BelgoNoFiltreli[i].PLAKA,
                            "SOFOR": BelgoNoFiltreli[i].SOFOR,
                            "BELGE_NO": BelgoNoFiltreli[i].BELGE_NO,
                            "ACTIVE": false,
                        });
                    }
                }

                DuzenlenmisBelgeler.sort((a, b) => {
                    const nameA = a.BELGE_NO.toUpperCase();
                    const nameB = b.BELGE_NO.toUpperCase();
                    if (nameA > nameB) {
                        return -1;
                    }
                    if (nameA < nameB) {
                        return 1;
                    }
                    return 0;
                });


                $("#DepoTransferBelgeTable").bootstrapTable("destroy");
                $('#DepoTransferBelgeTable').bootstrapTable({ data: DuzenlenmisBelgeler.filter(x => x.ACTIVE) });
            }
        }).done(function () {
            $("#DepoTransferBelgeTableProgress").hide();
            $("#DepoTransferBelgeTableRow").show();
            $("#DepoTransferBelgeTableToolbar").show();
        });

    }

    function DetailSatirStili(row, index) {
        if (row.ACTIVE) {
            return {
                css: {
                    "background-color": '#e9ebff'
                }
            }
        }

        return {
            css: {
                "background-color": '#FAEAEA'
            }
        }
    }

    $('#DepoTransferBelgeTable').on('expand-row.bs.table', function (e, index, row, $detail) {
        $detail.html(`<div class="card-body" style="background-color:mintcream;"> <div class="table-responsive"> <table id="SevkFormBelgeDetay${row.BELGE_NO}Table" class="belgedetailtbl table-sm" data-search="false" data-show-refresh="false" data-show-toggle="false" data-show-fullscreen="false" data-show-columns="false" data-show-columns-toggle-all="false" data-detail-view="false" data-show-export="false" data-click-to-select="true" data-minimum-count-columns="2" data-show-pagination-switch="false" data-page-size="4" data-page-list="[5,20,50,100]" data-pagination-parts="['pageInfo','pageList']" data-pagination="true" data-id-field="id" data-show-footer="false" data-mobile-responsive="true" data-response-handler="responseHandler" data-locale="tr-TR" data-row-style="DetailSatirStili"> <thead> <tr> <th data-formatter="NullCheck" data-field="SERI_NO" data-halign="center" data-align="center"  >SERİ NO</th> <th data-formatter="NullCheck" data-field="STOK_ADI" data-halign="center" data-align="center"  >STOK ADI</th>  <th data-formatter="MiktarFormatla" data-field="MIKTAR1" data-halign="center" data-align="center"  >MİKTAR 1</th> <th data-formatter="NullCheck" data-field="OLCU_BR1" data-halign="center" data-align="center"  >ÖLÇÜ BİRİMİ 1</th> <th data-formatter="MiktarFormatla" data-field="MIKTAR2" data-halign="center" data-align="center"  >MİKTAR 2</th> <th data-formatter="NullCheck" data-field="OLCU_BR2" data-halign="center" data-align="center"  >ÖLÇÜ BİRİMİ 2</th> <th data-formatter="KalinlikFormatter" data-field="ACIK2" data-halign="center" data-align="center"  >KALINLIK</th> <th data-formatter="GenislikFormatter" data-field="ACIK1" data-halign="center" data-align="center"  >GENİŞLİK</th> <th data-formatter="NullCheck" data-field="ACIK3" data-halign="center" data-align="center"  >ÜRÜN NO</th> <th data-formatter="NullCheck" data-field="SERI_NO_3" data-halign="center" data-align="center"  >KALİTE</th> <th data-formatter="NullCheck" data-field="SERI_NO_4" data-halign="center" data-align="center"  >KAPLAMA KALINLIĞI</th> <th data-formatter="BelgeDurumuFormatter" data-field="ACTIVE" data-halign="center" data-align="center"  >Durum</th> </tr></thead> </table> </div></div>`);

        var FiltreliBelgeler = DuzenlenmemisBelgeler.filter(x => x.SIPARIS_NO == row.SIPARIS_NO && x.BELGE_NO == row.BELGE_NO);

        var DuzenlenmisKayitlar = [];

        for (var i = 0; i < FiltreliBelgeler.length; i++)
        {
            DuzenlenmisKayitlar.push({
                "ACTIVE": FiltreliBelgeler[i].ACTIVE,
                "STOK_KODU": FiltreliBelgeler[i].STOK_KODU,
                "STOK_ADI": FiltreliBelgeler[i].STOK_ADI,
                "SERI_NO": FiltreliBelgeler[i].SERI_NO,
                "MIKTAR1": FiltreliBelgeler[i].MIKTAR1,
                "OLCU_BR1": FiltreliBelgeler[i].OLCU_BR1,
                "MIKTAR2": FiltreliBelgeler[i].MIKTAR2,
                "OLCU_BR2": FiltreliBelgeler[i].OLCU_BR2,
                "ACIK1": FiltreliBelgeler[i].ACIK1,
                "ACIK2": FiltreliBelgeler[i].ACIK2,
                "ACIK3": FiltreliBelgeler[i].ACIK3,
                "ACIKLAMA_4": FiltreliBelgeler[i].ACIKLAMA_4,
                "ACIKLAMA_5": FiltreliBelgeler[i].ACIKLAMA_5,
                "SERI_NO_3": FiltreliBelgeler[i].SERI_NO_3,
                "SERI_NO_4": FiltreliBelgeler[i].SERI_NO_4,
                "GIRIS_DEPO": FiltreliBelgeler[i].GIRIS_DEPO,
                "CIKIS_DEPO": FiltreliBelgeler[i].CIKIS_DEPO
            });
        }

        DuzenlenmisKayitlar.sort((a, b) => {
            const nameA = a.STOK_ADI.toUpperCase();
            const nameB = b.STOK_ADI.toUpperCase();
            if (nameA < nameB) {
                return -1;
            }
            if (nameA > nameB) {
                return 1;
            }
            return 0;
        });

        $(`#SevkFormBelgeDetay${row.BELGE_NO}Table`).bootstrapTable({ data: DuzenlenmisKayitlar });
    });
</script>

<script>
    function BelgeListIslemFormatter(e, index, row) {
        return `<button class="btn btn-primary" id="BelgeNoListAktarBtn" type="button" onclick="BelgeSec(event, '${index.SIPARIS_NO}', '${index.BELGE_NO}')">SEÇ</button>`
    }

    function BelgeDurumuFormatter(e, index, row) {
        return (index.ACTIVE == true) ? "AÇIK" : "KAPALI";
    }
</script>

<script>
    function BelgeSec(e, SiparisNo, BelgeNo) {
        e.stopPropagation();

        if (Kayitlar.length != 0) {
            Swal.fire({
                html: `<b>${BelgeNo}</b><br/> numaralı belgeyi seçmek istediğinize emin misiniz?`,
                text: "Kaydedilmeyen veriler var, bu işlem geri alınamaz!",
                icon: 'warning',
                showCancelButton: true,
                allowEnterKey: false,
                cancelButtonText: 'HAYIR',
                cancelButtonColor: '#d33',
                confirmButtonColor: '#3085d6',
                confirmButtonText: 'EVET',
                allowOutsideClick: false,
                customClass: 'AreYouSureAlert'
            }).then((result) => {
                if (result.isConfirmed) {
                    BelgeGoster(DuzenlenmemisBelgeler.filter(x => x.SIPARIS_NO == SiparisNo && x.BELGE_NO == BelgeNo));
                }
            });
        } else {
            BelgeGoster(DuzenlenmemisBelgeler.filter(x => x.SIPARIS_NO == SiparisNo && x.BELGE_NO == BelgeNo));
        }
    }
    var EskiBelgeler = [];

    function BelgeGoster(data) {
        KayitTipi = 1;
        SayfaTipi = 9;

        Kayitlar = [];
        KayitId = 0;

        GuncellenenId = -1;

        SeciliStokKodu = "";

        $("#SevkFormBelge").modal("hide");

        $("#SİPARİS_NO").html(data[0].SIPARIS_NO);

        $("#BELGE_NO").html(data[0].BELGE_NO);
        BELGE_NO = data[0].BELGE_NO;
        BelgeNoFormat();


        for (var i = 0; i < data.length; i++) {
            Kayitlar.push({
                "INC_KEY": data[i].INCKEY,
                "ACTIVE": data[i].ACTIVE,
                "ID": KayitId,
                "CARI_ISIM": data[i].CARI_ISIM,
                "STOK_ADI": data[i].STOK_ADI,
                "STOK_KODU": data[i].STOK_KODU,
                "MIKTAR": data[i].MIKTAR1,
                "OLCU_BR1": data[i].OLCU_BR1,
                "MIKTAR2": data[i].MIKTAR2,
                "OLCU_BR2": data[i].OLCU_BR2,
                "SERI_NO": data[i].SERI_NO,
                "ACIK1": data[i].ACIK2,
                "ACIK2": data[i].ACIK1,
                "ACIK3": data[i].ACIK3,
                "SERI_NO_3": data[i].SERI_NO_3,
                "SERI_NO_4": data[i].SERI_NO_4,
                "ACIKLAMA_4": data[i].ACIKLAMA_4,
                "ACIKLAMA_5": data[i].ACIKLAMA_5,
                "ESKI_MIKTAR": data[i].MIKTAR1,
                "ESKI_MIKTAR2": data[i].MIKTAR2,
                "GIRIS_DEPO": data[i].GIRIS_DEPO,
                "CIKIS_DEPO": data[i].CIKIS_DEPO,
                "PLAKA": data[i].PLAKA,
                "SOFOR": data[i].SOFOR
            });

            KayitId += 1;
        }

        EskiBelgeler = data;

        var GirisDep = Depolar.filter(x => x.DEPO_KODU == Kayitlar[0].GIRIS_DEPO)[0];
        var CikisDep = Depolar.filter(x => x.DEPO_KODU == Kayitlar[0].CIKIS_DEPO)[0];

        GirisDepo = GirisDep.DEPO_KODU;
        CikisDepo = CikisDep.DEPO_KODU;

        $('#GIRIS_DEPO').val(GirisDep.DEPO_ISMI);
        $('#CIKIS_DEPO').val(CikisDep.DEPO_ISMI);

        $('#PLAKA').val(Kayitlar[0].PLAKA);
        $('#SOFOR').val(Kayitlar[0].SOFOR);

        Kayitlar.sort((a, b) => {
            const nameA = a.STOK_ADI.toUpperCase();
            const nameB = b.STOK_ADI.toUpperCase();
            if (nameA < nameB) {
                return -1;
            }
            if (nameA > nameB) {
                return 1;
            }
            return 0;
        });

        $("#BELGE_DURUMU").prop('checked', false);
        $('#YeniBelgeOlusturButton').removeClass('i-disabled');
        $('#belgesilbtn').show();

        StokAdlariGetir();

        if (Kayitlar.filter(x => x.ACTIVE === true).length > 0) {
            $("#BELGE_DURUMU").prop('checked', true);
        }

        $('#DepoTransferTable').bootstrapTable('load', Kayitlar);

        DurumDegisikligi(0);

        BelgeyiKaydetButonKontrol();

        TonajGuncelle();
    }
    function DurumSecim() {
        var DocumentStateVal = $('input[name="DocumentStateRadio"]:checked').val();
        var DocState = DocumentStateVal == "all" ? "all" : (DocumentStateVal === 'true');

        if (DocState == "all") {
            Belge = DuzenlenmisBelgeler;
        }
        else if (DocState) {
            Belge = DuzenlenmisBelgeler.filter(x => x.ACTIVE);
        }
        else {
            Belge = DuzenlenmisBelgeler.filter(x => !x.ACTIVE);
        }

        $("#DepoTransferBelgeTable").bootstrapTable("destroy");
        $('#DepoTransferBelgeTable').bootstrapTable({ data: Belge });
    }
</script>

<script>
    function BelgeNoGetir() {
        return new Promise((resolve, reject) => {
            $.ajax({
                url: "http://192.168.2.13:83/api/shipping/" + SayfaTipi,
                type: 'GET',
                success: function (data) {
                    if (data.length > 0) {
                        resolve(data[0].SIRADAKI_BELGE_NO);
                    }
                },
                error: function (error) {
                    reject(error)
                },
            })
        });
    }

    function BelgeNoFormat() {
        var BELGE_NO = $('#BELGE_NO').html();
        var BELGE_HARF = BELGE_NO[0];
        var SIFIR_SAYI = 0;

        for (var i = 1; i < BELGE_NO.length - 4; i++) {
            if (BELGE_NO[i] == '0') {
                SIFIR_SAYI++;
            }
            else {
                break;
            }
        }

        $('#BELGE_NO').html(BELGE_HARF + '-' + BELGE_NO.substring(SIFIR_SAYI));
    }

    function BelgeNoDegisti() {
        var ProcUrl = "http://192.168.2.13:83/api/shipping/" + SayfaTipi;

        $.getJSON(ProcUrl, function (data) {
            $('#BELGE_NO').html(data[0].SIRADAKI_BELGE_NO)
        }).done(() => {
            Swal.fire({
                title: `${$('#BELGE_NO').html()}`,
                text: `Belge numaranız üstteki belge numarası ile değişmiştir.`,
                icon: 'warning',
                showCancelButton: false,
                confirmButtonColor: '#3085d6',
                confirmButtonText: 'TAMAM',
                allowOutsideClick: false,
            }).then((result) => {
                if (result.isConfirmed) {
                    BelgeKaydet();
                }
            })
        });
    }

    function YeniBelgeOlustur() {

        Swal.fire({
            html: `Yeni belge oluşturulacak, emin misiniz?`,
            icon: 'warning',
            showCancelButton: true,
            cancelButtonText: 'HAYIR',
            cancelButtonColor: '#d33',
            confirmButtonColor: '#3085d6',
            allowEnterKey: false,
            confirmButtonText: 'EVET',
            allowOutsideClick: false
        }).then((result) => {
            if (result.isConfirmed)
            {
                YeniBelge();
            }
        });
        
    }
    
    function YeniBelge()
    {
        $('#YeniBelgeOlusturButton').addClass('i-disabled');
        $('#belgesilbtn').hide();
        $('#BELGE_DURUMU').prop("checked", true);

        BelgeNoGetir().then((data) => {
            BELGE_NO = data;
            $('#BELGE_NO').html(data);
            BelgeNoFormat();
        });

        KayitTipi = 0;
        SayfaTipi = 9;

        Kayitlar = [];
        KayitId = 0;

        GuncellenenId = -1;
        Silinecek_Kayitlar = [];
        GirisDepo = -1;
        CikisDepo = -1;

        SeciliStokKodu = "";

        $('#DepoTransferTable').bootstrapTable('destroy');
        $('#DepoTransferTable').bootstrapTable({ data: [] });

        $('#GIRIS_DEPO').val("");
        $('#CIKIS_DEPO').val("");

        $('#PLAKA').val("");
        $('#SOFOR').val("");

        AlanlariTemizle();
        DurumDegisikligi(0);
        TonajGuncelle();
    }
</script>
